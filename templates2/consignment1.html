{% extends "base.html" %} 
{% block content %}  
<style>
    /* Adjusted main content container margin to account for fixed header */
    .form-container {
        background-color: #ffffff;
        padding: 30px 40px;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 1000px;
        box-sizing: border-box;
        margin: 0 auto 30px auto;
        /* Changed top margin from 30px to 0 */
        flex-grow: 1;
        /* Allow form to take up remaining space */
    }

    h2 {
        text-align: center;
        color: #4a148c;
        margin-bottom: 25px;
        animation: slideUp 0.8s ease forwards;
        transform: translateY(20px);
    }

    form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px 45px;
        animation: slideUp 0.8s ease forwards;
        transform: translateY(20px);
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(100%);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    form p {
        margin: 0;
    }

    label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
        color: #333;
    }

    input,
    select,
    textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        background-color: #f9f9f9;
        /* Remove default spin buttons from number inputs */
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    textarea {
        resize: vertical;
    }

    .full-width {
        grid-column: 1 / 3;
    }

    /* Styles for input/select group with add button */
    .input-with-button {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .input-with-button input,
    .input-with-button select,
    .input-with-button textarea {
        flex: 1;
    }

    .add-btn {
        padding: 6px 12px;
        background-color: #4CAF50;
        border: none;
        color: white;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
    }

    .add-btn i {
        pointer-events: none;
    }

    .add-btn:hover {
        background-color: #388e3c;
    }

    button[type="submit"] {
        grid-column: 1 / 3;
        padding: 12px;
        background-color: #6a1b9a;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button[type="submit"]:hover {
        background-color: #4a148c;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        form {
            grid-template-columns: 1fr;
        }

        .full-width,
        button[type="submit"] {
            grid-column: 1 / 2;
        }

        .main-nav {
            flex-direction: column;
            padding: 10px;
            align-items: flex-start;
            /* Align nav items to start on small screens */
        }

        .main-nav a,
        .dropdown .dropbtn {
            margin: 5px 0;
            width: calc(100% - 20px);
            /* Make links span almost full width */
            text-align: left;
            /* Align text to left in stacked mode */
        }

        .dropdown-content {
            position: static;
            /* Remove absolute positioning on small screens */
            width: 100%;
            /* Take full width on small screens */
            box-shadow: none;
            /* Remove shadow to blend better */
            border-top: 1px solid #eee;
            /* Add a separator */
        }
    }

    /* --- START OF ENHANCED MODAL STYLES (INCLUDING SPECIFIC VEHICLE MODAL) --- */

    /* Modal Overlay Styles - HIDDEN BY DEFAULT */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        /* Darker, more prominent overlay */
        display: none;
        /* Changed to none */
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
        /* Subtle blur effect on background */
        animation: fadeInOverlay 0.3s forwards;
        /* Fade in animation */
    }

    /* Modal Content Styles */
    .modal-content {
        background: linear-gradient(135deg, #f0f4f8, #e9ecf0);
        /* Subtle gradient background */
        padding: 30px;
        /* Increased padding */
        border-radius: 15px;
        /* More rounded corners */
        width: 90%;
        max-width: 450px;
        /* Adjusted max-width for a good size */
        position: relative;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        /* Stronger shadow for depth */
        animation: slideInModal 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        /* Pop-out animation */
        border: 1px solid #dcdcdc;
        /* Subtle border */
        max-height: 90vh;
        /* Allow modal to take up more vertical space */
        overflow-y: auto;
        /* Enable scrolling for content overflow */
    }

    @keyframes fadeInOverlay {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideInModal {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Modal Close Button */
    .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 30px;
        /* Larger close icon */
        cursor: pointer;
        color: #777;
        /* Softer color */
        transition: color 0.2s ease, transform 0.2s ease;
    }

    .modal-close-btn:hover {
        color: #333;
        /* Darker on hover */
        transform: rotate(90deg);
        /* Spin on hover */
    }

    /* Modal Heading */
    .modal-content h3 {
        text-align: center;
        color: #6a1b9a;
        /* Deep purple, consistent with header */
        margin-bottom: 25px;
        /* Increased margin */
        font-size: 1.8em;
        /* Larger font size */
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        /* Subtle text shadow */
    }

    /* Modal Form Group */
    .modal-form-group {
        margin-bottom: 20px;
        /* Increased spacing between form groups */
    }

    .modal-form-group label {
        display: block;
        /* Label on its own line */
        margin-bottom: 8px;
        /* Space below label */
        font-weight: 600;
        /* Bolder label text */
        color: #444;
        /* Slightly darker label color */
        font-size: 0.95rem;
    }

    .modal-form-group input[type="text"],
    .modal-form-group input[type="date"],
    .modal-form-group textarea,
    /* Ensure textarea is styled */
    .modal-form-group select {
        width: 100%;
        /* Full width within modal content */
        padding: 12px;
        /* Increased padding */
        border: 1px solid #cdd4da;
        /* Softer border */
        border-radius: 8px;
        /* More rounded input fields */
        font-size: 1rem;
        /* Standard font size */
        box-sizing: border-box;
        /* Include padding in width */
        outline: none;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        background-color: #fcfdff;
        /* Very light input background */
    }

    .modal-form-group input[type="text"]:focus,
    .modal-form-group input[type="date"]:focus,
    .modal-form-group textarea:focus,
    .modal-form-group select:focus {
        border-color: #8e24aa;
        /* Purple border on focus */
        box-shadow: 0 0 0 3px rgba(142, 36, 170, 0.25);
        /* Glow effect on focus */
    }

    /* Modal Button (Add/Update) */
    .modal-add-btn {
        display: block;
        width: 100%;
        padding: 14px;
        /* Increased padding */
        background: linear-gradient(to right, #8e24aa, #6a1b9a);
        /* Gradient button */
        color: white;
        border: none;
        border-radius: 8px;
        /* More rounded button */
        font-size: 1.1rem;
        /* Larger font size */
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        /* Stronger shadow */
        transition: all 0.3s ease;
        letter-spacing: 0.5px;
        /* Slightly increased letter spacing */
        margin-top: 25px;
        /* More space above the button */
    }

    .modal-add-btn:hover {
        background: linear-gradient(to left, #8e24aa, #6a1b9a);
        /* Reverse gradient on hover */
        transform: translateY(-2px);
        /* Slight lift on hover */
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        /* Deeper shadow on hover */
    }

    /* Modal Table (Inside Modals) */
    .modal-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        /* Increased margin from modal inputs */
        border-radius: 10px;
        /* Rounded corners for modal table */
        overflow: hidden;
        /* Ensures rounded corners apply */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        /* Subtle shadow */
    }

    .modal-table th,
    .modal-table td {
        border: 1px solid #e0e0e0;
        /* Lighter borders */
        padding: 10px;
        /* Slightly more padding */
        text-align: left;
        font-size: 0.9em;
        vertical-align: middle;
    }

    .modal-table th {
        background-color: #7b1fa2;
        /* Deep purple header for modal tables */
        color: white;
        font-weight: bold;
        text-transform: uppercase;
    }

    /* Specific rounded corners for modal table headers */
    .modal-table th:first-child {
        border-top-left-radius: 10px;
    }

    .modal-table th:last-child {
        border-top-right-radius: 10px;
    }


    .modal-table td.actions {
        display: flex;
        gap: 15px;
        /* Adjusted gap */
        justify-content: center;
        white-space: nowrap;
    }

    .modal-table td.actions button {
        font-size: 1.1em;
        /* Slightly smaller for table icons */
        transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
        padding: 5px;
        /* Small padding for click area */
    }

    .modal-table td.actions .select-btn {
        color: #2196F3;
        /* Blue for select */
    }

    .modal-table td.actions .select-btn:hover {
        color: #1976D2;
        transform: scale(1.15);
    }

    .modal-table td.actions .delete-btn {
        color: #f44336;
        /* Red for delete */
    }

    .modal-table td.actions .delete-btn:hover {
        color: #d32f2f;
        transform: scale(1.15);
    }

    /* Loading Indicator */
    .loading-indicator {
        text-align: center;
        margin-top: 20px;
        color: #6a1b9a;
        font-style: italic;
        display: none;
        font-weight: 500;
        animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes pulse {
        0% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.6;
        }
    }

    /* Messages within Modals (e.g., vehicleMessage) */
    .modal-content>div[style*="color"] {
        /* Targets message divs in modals */
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
        font-size: 0.9em;
    }

    #vehicleMessage {
        color: #28a745;
        /* Green for success */
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
    }

    /* For error messages, if any, you might want to add a red style */
    /* .error-message-style { color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c6cb; } */


    /* Styles for Goods Information Table */
    .goods-info-container {
        margin-top: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #fdfdfd;
    }

    .goods-info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
    }

    .goods-info-table th,
    .goods-info-table td {
        border: 1px solid #eee;
        padding: 8px;
        text-align: left;
        vertical-align: middle;
    }

    .goods-info-table th {
        background-color: #f9f9f9;
        font-weight: bold;
        color: #555;
    }

    /* NEW: Styles for Goods Information Table Columns */
    .goods-info-table th:nth-child(1),
    /* Box */
    .goods-info-table td:nth-child(1) {
        width: 13%;
        /* Increased width for Box */
    }

    .goods-info-table th:nth-child(2),
    /* Unit */
    .goods-info-table td:nth-child(2) {
        width: 13%;
    }

    .goods-info-table th:nth-child(3),
    /* Quantity */
    .goods-info-table td:nth-child(3) {
        width: 13%;
        /* Adjusted for better spacing */
    }

    .goods-info-table th:nth-child(4),
    /* Rate */
    .goods-info-table td:nth-child(4) {
        width: 13%;
    }

    .goods-info-table th:nth-child(5),
    /* GI Amount */
    .goods-info-table td:nth-child(5) {
        width: 12%;
    }

    .goods-info-table th:nth-child(6),
    /* From Party */
    .goods-info-table td:nth-child(6) {
        width: 12%;
        /* Can be wider for party names */
    }

    .goods-info-table th:nth-child(7),
    /* To Party */
    .goods-info-table td:nth-child(7) {
        width: 13%;
        /* Can be wider for party names */
    }

    .goods-info-table th:nth-child(8),
    /* Actions */
    .goods-info-table td:nth-child(8) {
        width: 13%;
    }


    .goods-info-table input[type="text"],
    .goods-info-table input[type="number"] {
        width: calc(100% - 16px);
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1em;
        background-color: #fff;
        /* Remove default spin buttons from number inputs */
    }

    .goods-info-table input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .goods-info-table select {
        /* Added style for select elements in goods table */
        width: calc(100% - 16px);
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1em;
        background-color: #fff;
    }

    .goods-info-table .table-action-btn {
        background: none;
        border: none;
        padding: 0;
        font-size: 1.2em;
        cursor: pointer;
        transition: color 0.3s ease;
        line-height: 1;
        margin: 0 5px;
    }

    .goods-info-table .edit-goods-item-btn {
        color: #FFC107;
    }

    .goods-info-table .edit-goods-item-btn:hover {
        color: #FFA000;
    }

    .goods-info-table .remove-goods-item-btn {
        color: #f44336;
    }

    .goods-info-table .remove-goods-item-btn:hover {
        color: #d32f2f;
    }

    /* CSS for centering the "Add Goods Item" button */
    #addGoodsItemBtn {
        display: block;
        margin: 15px auto 0 auto;
        width: fit-content;
    }

    /* Custom Confirmation Modal Styles */
    #confirmationModalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        /* Darker, more prominent overlay */
        display: none;
        /* Changed to none */
        justify-content: center;
        align-items: center;
        z-index: 1002;
        backdrop-filter: blur(5px);
        animation: fadeInOverlay 0.3s forwards;
        /* display: none; */
        /* Hidden by default */
    }

    #confirmationModalContent {
        background: linear-gradient(135deg, #f0f4f8, #e9ecf0);
        /* Subtle gradient background */
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 400px;
        text-align: center;
        border: 1px solid #dcdcdc;
        animation: slideInModal 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
    }

    #confirmationModalContent p {
        font-size: 1.1em;
        margin-bottom: 25px;
        /* Increased margin */
        color: #333;
        font-weight: 500;
    }

    #confirmationModalButtons {
        display: flex;
        justify-content: center;
        gap: 20px;
        /* Increased gap */
    }

    #confirmYesBtn,
    #confirmNoBtn {
        padding: 12px 25px;
        /* Increased padding */
        border: none;
        border-radius: 8px;
        /* More rounded buttons */
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
        /* Consistent minimum width */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        /* Subtle shadow */
    }

    #confirmYesBtn {
        background-color: #e53935;
        /* Brighter red */
        color: white;
    }

    #confirmYesBtn:hover {
        background-color: #c62828;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }

    #confirmNoBtn {
        background-color: #e0e0e0;
        color: #555;
    }

    #confirmNoBtn:hover {
        background-color: #c0c0c0;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }


    /* --- NEW/ENHANCED SUCCESS POPUP STYLES --- */
    .success-popup {
        position: fixed;
        top: -100px;
        /* Start off-screen above */
        left: 50%;
        transform: translateX(-50%);
        background-color: #4CAF50;
        /* Green background */
        color: white;
        padding: 15px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        font-weight: 500;
        text-align: center;
        z-index: 9999;
        /* Ensure it's on top */
        opacity: 0;
        /* Start hidden */
        transition: top 0.5s ease-out, opacity 0.5s ease-out;
        /* Smooth transition */
        min-width: 250px;
    }

    .success-popup.show {
        top: 20px;
        /* Slide down to 20px from top */
        opacity: 1;
        /* Fade in */
    }
</style>

<div class="form-container">
    <h2>Consignment Note Form</h2>
    <form id="consignmentForm" method="post" action="{% url 'consignment' %}">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- Row 1: CNID, Vehicle No and CN No -->
        <div class="full-width" style="display: flex; gap: 30px; flex-wrap: wrap;">
            {# New CNID field #}
            <div style="flex: 1; min-width: 280px;">
                <label for="id_cn_note_id">CNID</label>
                <input type="text" id="id_cn_note_id" name="cn_note_id" value="" readonly>
                <!-- Corrected ID to id_cn_note_id to match JS -->
            </div>

            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Vehicle_No.id_for_label }}">{{ form.Vehicle_No.label }}</label>
                <div class="input-with-button">
                    {# Select dropdown for Vehicle_No #}
                    <select name="{{ form.Vehicle_No.name }}" id="{{ form.Vehicle_No.id_for_label }}">
                        <option value="">Select a Vehicle No</option>
                        {# Options will be dynamically loaded by JavaScript #}
                    </select>
                    <button type="button" class="add-btn" id="addVehicleBtn" title="Add New Vehicle">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                {% if form.Vehicle_No.errors %}
                <span style="color: red;">{{ form.Vehicle_No.errors|striptags }}</span>
                {% endif %}
            </div>

            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Cn_No.id_for_label }}">{{ form.Cn_No.label }}</label>
                <div class="input-with-button">
                    {# Now a normal text input for CN No #}
                    <input type="text" name="{{ form.Cn_No.name }}" id="{{ form.Cn_No.id_for_label }}"
                        placeholder="Enter CN No">
                </div>
                {% if form.Cn_No.errors %}
                <span style="color: red;">{{ form.Cn_No.errors|striptags }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Row 2: Consignee and Consignor in one row -->
        <div class="full-width" style="display: flex; gap: 30px; flex-wrap: wrap;">
            <!-- Consignee Field Block -->
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.consignee.id_for_label }}">{{ form.consignee.label }}</label>
                <div class="input-with-button">
                    {# Select dropdown for consignee #}
                    <select name="{{ form.consignee.name }}" id="{{ form.consignee.id_for_label }}">
                        <option value="">Select Consignee</option>
                        {# Options will be dynamically loaded by JavaScript #}
                    </select>
                    <button type="button" class="add-btn" id="addConsigneeBtn" title="Add Consignee">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                {% if form.consignee.errors %}
                <span style="color: red;">{{ form.consignee.errors|striptags }}</span>
                {% endif %}
            </div>

            <!-- Consignor Field Block -->
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.consigner.id_for_label }}">{{ form.consigner.label }}</label>
                <div class="input-with-button">
                    {# Select dropdown for consigner #}
                    <select name="{{ form.consigner.name }}" id="{{ form.consigner.id_for_label }}">
                        <option value="">Select Consignor</option>
                        {# Options will be dynamically loaded by JavaScript #}
                    </select>
                    <button type="button" class="add-btn" id="addConsignerBtn" title="Add Consignor">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                {% if form.consigner.errors %}
                <span style="color: red;">{{ form.consigner.errors|striptags }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Row 3: From Location and To Location -->
        <div class="full-width" style="display: flex; gap: 30px; flex-wrap: wrap;">
            <!-- From Location Field Block -->
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.from_location.id_for_label }}">{{ form.from_location.label }}</label>
                <div class="input-with-button">
                    <select name="{{ form.from_location.name }}" id="{{ form.from_location.id_for_label }}">
                        <option value="">Select From Location</option>
                        {# Options will be dynamically loaded by JavaScript #}
                    </select>
                    <button type="button" class="add-btn" id="addFromLocationBtn" title="Add Location">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                {% if form.from_location.errors %}
                <span style="color: red;">{{ form.from_location.errors|striptags }}</span>
                {% endif %}
            </div>

            <!-- To Location Field Block -->
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.To_Location.id_for_label }}">{{ form.To_Location.label }}</label>
                <div class="input-with-button">
                    <select name="{{ form.To_Location.name }}" id="{{ form.To_Location.id_for_label }}">
                        <option value="">Select To Location</option>
                        {# Options will be dynamically loaded by JavaScript #}
                    </select>
                    <button type="button" class="add-btn" id="addToLocationBtn" title="Add Location">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                {% if form.To_Location.errors %}
                <span style="color: red;">{{ form.To_Location.errors|striptags }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Goods Information Section - NOW A TABLE (Moved here) -->
        <div class="full-width">
            <label>Goods Information</label>
            <div class="goods-info-container">
                <table class="goods-info-table">
                    <thead>
                        <tr>
                            <!-- <th>GI ID</th> {# New Header #} -->
                            <th>Unit</th>
                            <th>Quantity (Kg)</th>
                            <th>Rate</th>
                            <th>GI Amount</th>
                            <th>From Party</th>
                            <th>To Party</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="goodsTableBody">
                        <tr class="example-row" style="background-color: #fff3cd;">
                            <td><input type="text" placeholder="Unit" disabled></td>
                            <td><input type="number" placeholder="Quantity" disabled value="0"></td> <!-- Added default value -->
                            <td><input type="number" placeholder="Rate" disabled value="0"></td>     <!-- Added default value -->
                            <td><input type="number" placeholder="Amount" disabled value="0"></td>  <!-- Added default value -->
                            <td><input type="text" placeholder="From Party" disabled></td>
                            <td><input type="text" placeholder="To Party" disabled></td>
                            <td style="text-align: center; color: #999;">Example</td>
                        </tr>
                    </tbody>

                </table>
                <button type="button" class="add-btn" id="addGoodsItemBtn">
                    Add Goods Item
                </button>
            </div>

            <!-- Hidden input to store JSON string of goods items -->
            <input type="hidden" name="{{ form.goods_info.name }}" id="{{ form.goods_info.id_for_label }}">
            <!-- NEW: Hidden input to store the calculated total_fare of goods -->
            <input type="hidden" name="{{ form.total_fare.name }}" id="{{ form.total_fare.id_for_label }}">


            {% if form.goods_info.errors %}
            <span style="color: red;">{{ form.goods_info.errors|striptags }}</span>
            {% endif %}
        </div>



        <!-- Other Fields: Exclude those explicitly placed (CNID, Vehicle_No, cn_no, consignee, consigner, from_location, To_Location, goods_info) -->
        <div class="full-width" style="display: flex; gap: 30px; flex-wrap: wrap;">
            {# Booking Date #}
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Booking_Date.id_for_label }}">{{ form.Booking_Date.label }}</label>
                {{ form.Booking_Date }}
                {% if form.Booking_Date.errors %}
                <span style="color: red;">{{ form.Booking_Date.errors|striptags }}</span>
                {% endif %}
            </div>

            {# Loading Date #}
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Loading_Date.id_for_label }}">{{ form.Loading_Date.label }}</label>
                {{ form.Loading_Date }}
                {% if form.Loading_Date.errors %}
                <span style="color: red;">{{ form.Loading_Date.errors|striptags }}</span>
                {% endif %}
            </div>

            {# Unloading Date #}
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Unloading_Date.id_for_label }}">{{ form.Unloading_Date.label }}</label>
                {{ form.Unloading_Date }}
                {% if form.Unloading_Date.errors %}
                <span style="color: red;">{{ form.Unloading_Date.errors|striptags }}</span>
                {% endif %}
            </div>

            {# NEW FIELD: Innam #}
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Innam.id_for_label }}">{{ form.Innam.label }}</label>
                <input type="number" name="{{ form.Innam.name }}" id="{{ form.Innam.id_for_label }}"
                    value="{{ form.Innam.value|default:'0' }}">
                {% if form.Innam.errors %}
                <span style="color: red;">{{ form.Innam.errors|striptags }}</span>
                {% endif %}
            </div>

            {# NEW FIELD: Truck Freight #}
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Truck_Freight.id_for_label }}">{{ form.Truck_Freight.label }}</label>
                <input type="number" name="{{ form.Truck_Freight.name }}" id="{{ form.Truck_Freight.id_for_label }}"
                    value="{{ form.Truck_Freight.value|default:'0.00' }}">
                {% if form.Truck_Freight.errors %}
                <span style="color: red;">{{ form.Truck_Freight.errors|striptags }}</span>
                {% endif %}
            </div>

            {# NEW FIELD: Extra TF #}
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Extra_TF.id_for_label }}">{{ form.Extra_TF.label }}</label>
                <input type="number" name="{{ form.Extra_TF.name }}" id="{{ form.Extra_TF.id_for_label }}"
                    value="{{ form.Extra_TF.value|default:'0.00' }}">
                {% if form.Extra_TF.errors %}
                <span style="color: red;">{{ form.Extra_TF.errors|striptags }}</span>
                {% endif %}
            </div>

            {# Advance Amount #}
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Advance_Amount.id_for_label }}">{{ form.Advance_Amount.label }}</label>
                {{ form.Advance_Amount }}
                {% if form.Advance_Amount.errors %}
                <span style="color: red;">{{ form.Advance_Amount.errors|striptags }}</span>
                {% endif %}
            </div>

            {# Balance Amount #}
            <div style="flex: 1; min-width: 280px;">
                <label for="{{ form.Balance_Amount.id_for_label }}">To Pay</label>
                {{ form.Balance_Amount }}
                {% if form.Balance_Amount.errors %}
                <span style="color: red;">{{ form.Balance_Amount.errors|striptags }}</span>
                {% endif %}
            </div>
        </div>

        <button type="submit">Save</button>
    </form>
</div>

<!-- Vehicle Management Modal (Enhanced) -->
<div id="vehicleModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" id="closeVehicleModalBtn">&times;</button>
        <h3>Manage Vehicle Numbers</h3>

        <div class="modal-form-group">
            <label for="newVehicleNo">Vehicle Number:</label>
            <input type="text" id="newVehicleNo" placeholder="e.g., MH01AB1234">
        </div>
        <div class="modal-form-group">
            <label for="newVehicleDate">Date Added:</label>
            <input type="date" id="newVehicleDate" value="{{ 'now'|date:'Y-m-d' }}">
        </div>
        <button class="modal-add-btn" id="addNewVehicleBtn">Add Vehicle</button>
        <div id="vehicleLoading" class="loading-indicator">Processing...</div>
        <div id="vehicleMessage" style="color: green; text-align: center; margin-top: 10px;"></div>

        <table class="modal-table">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Vehicle No.</th>
                    <th>Date Added</th>
                    <th>Actions</th> {# Added Actions column #}
                </tr>
            </thead>
            <tbody id="vehicleTableBody">
                <!-- Vehicle data will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Consignee Management Modal (Enhanced) -->
<div id="consigneeModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" id="closeConsigneeModalBtn">&times;</button>
        <h3>Manage Consignees</h3>

        <div class="modal-form-group">
            <label for="newConsigneeName">Consignee Name:</label>
            <input type="text" id="newConsigneeName" placeholder="e.g., ABC Logistics">
        </div>
        <div class="modal-form-group">
            <label for="newConsigneeDate">Date Added:</label>
            <input type="date" id="newConsigneeDate" value="{{ 'now'|date:'Y-m-d' }}">
        </div>
        <div class="modal-form-group">
            <label for="newConsigneeAddress">Address:</label>
            <textarea id="newConsigneeAddress" rows="3" placeholder="Enter consignee address"></textarea>
        </div>
        <button class="modal-add-btn" id="addNewConsigneeBtn">Add Consignee</button>
        <div id="consigneeLoading" class="loading-indicator">Processing...</div>
        <div id="consigneeMessage" style="color: green; text-align: center; margin-top: 10px;"></div>

        <table class="modal-table">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Consignee Name</th>
                    <th>Date</th>
                    <th>Address</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="consigneeTableBody">
                <!-- Consignee data will be loaded here -->
            </tbody>
        </table>
    </div>
</div>


<!-- Consigner Management Modal (Enhanced) -->
<div id="consignerModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" id="closeConsignerModalBtn">&times;</button>
        <h3>Manage Consigners</h3>

        <div class="modal-form-group">
            <label for="newConsignerName">Consigner Name:</label>
            <input type="text" id="newConsignerName" placeholder="e.g., ABC Logistics">
        </div>
        <div class="modal-form-group">
            <label for="newConsignerDate">Date Added:</label>
            <input type="date" id="newConsignerDate" value="{{ 'now'|date:'Y-m-d' }}">
        </div>
        <div class="modal-form-group">
            <label for="newConsignerAddress">Address:</label>
            <textarea id="newConsignerAddress" rows="3" placeholder="Enter consigner address"></textarea>
        </div>
        <button class="modal-add-btn" id="addNewConsignerBtn">Add Consigner</button>
        <div id="consignerLoading" class="loading-indicator">Processing...</div>
        <div id="consignerMessage" style="color: green; text-align: center; margin-top: 10px;"></div>

        <table class="modal-table">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Consigner Name</th>
                    <th>Date</th>
                    <th>Address</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="consignerTableBody">
                <!-- Consigner data will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Location Management Modal (Enhanced) -->
<div id="locationModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" id="closeLocationModalBtn">&times;</button>
        <h3>Manage Locations</h3>

        <div class="modal-form-group">
            <label for="newLocationName">Location Name:</label>
            <input type="text" id="newLocationName" placeholder="e.g., Nagpur">
        </div>
        <div class="modal-form-group">
            <label for="newLocationDate">Date Added:</label>
            <input type="date" id="newLocationDate" value="{{ 'now'|date:'Y-m-d' }}">
        </div>
        <button class="modal-add-btn" id="addNewLocationBtn">Add Location</button>
        <div id="locationLoading" class="loading-indicator">Processing...</div>
        <div id="locationMessage" style="color: green; text-align: center; margin-top: 10px;"></div>

        <table class="modal-table">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Location</th>
                    <th>Date Added</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="locationTableBody">
                <!-- Location data will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- The Consignment Note Management Modal has been completely removed as requested -->

<!-- Custom Confirmation Modal (Enhanced) -->
<div id="confirmationModalOverlay" class="modal-overlay">
    <div id="confirmationModalContent" class="modal-content">
        <p id="confirmationMessage"></p>
        <div id="confirmationModalButtons">
            <button id="confirmYesBtn">Yes</button>
            <button id="confirmNoBtn">No</button>
        </div>
    </div>
</div>

<!-- Success Popup Element (Enhanced) -->
<div id="successPopup" class="success-popup">
    Action successful!
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Common UI Elements and Utilities ---
        const successPopup = document.getElementById('successPopup');
        const consignmentForm = document.getElementById('consignmentForm');
        const goodsInfoHiddenInput = document.getElementById('{{ form.goods_info.id_for_label }}');
        const totalFareHiddenInput = document.getElementById('{{ form.total_fare.id_for_label }}'); // NEW: Get the hidden total_fare input
        const cnidInputField = document.getElementById('id_cn_note_id');
        const truckFreightInput = document.getElementById('{{ form.Truck_Freight.id_for_label }}');
        let totalFareSummaryInput = document.getElementById('totalFareSummary'); // Retrieve at load time

        // Global arrays to hold fetched master data
        let goodsItemsData = [];
        let allConsignees = [];
        let allConsigners = [];

        // Custom Confirmation Modal elements
        const confirmationModalOverlay = document.getElementById('confirmationModalOverlay');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        let confirmCallback = null;

        // Function to show custom confirmation modal
        function showConfirmationModal(message, callback) {
            confirmationMessage.textContent = message;
            confirmCallback = callback;
            confirmationModalOverlay.style.display = 'flex';
        }

        // Event listeners for custom confirmation modal buttons
        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            confirmationModalOverlay.style.display = 'none';
        });

        confirmNoBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(false);
            }
            confirmationModalOverlay.style.display = 'none';
        });

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // --- Show/Hide Success Popup ---
        function showSuccessPopup(message) {
            console.log("Success:", message);
            successPopup.textContent = message;
            successPopup.style.display = 'block'; // Make it visible
            successPopup.classList.add('show'); // Add 'show' class to trigger animation
            setTimeout(() => {
                successPopup.classList.remove('show'); // Remove 'show' class to trigger reverse animation
                setTimeout(() => {
                    successPopup.style.display = 'none'; // Hide it completely after animation
                }, 500); // This should match the transition duration
            }, 3000); // Display for 3 seconds
        }


        // --- Fetch and Display Next CNID (Remains for main form) ---
        async function fetchAndDisplayNextCNID() {
            try {
                const response = await fetch('/consignments/get_next_cnid/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    if (cnidInputField) { // Added null check
                        cnidInputField.value = data.next_cn_id;
                    }
                } else {
                    console.error('Error fetching next CNID:', data.message || 'Unknown error');
                    if (cnidInputField) { // Added null check
                        cnidInputField.value = 'Error';
                    }
                }
            }
            catch (error) {
                console.error('Network error fetching next CNID:', error);
                if (cnidInputField) { // Added null check
                    cnidInputField.value = 'N/A';
                }
            }
        }


        // --- Vehicle Management ---
        const addVehicleBtn = document.getElementById('addVehicleBtn');
        const vehicleModalOverlay = document.getElementById('vehicleModalOverlay');
        const closeVehicleModalBtn = document.getElementById('closeVehicleModalBtn');
        const addNewVehicleBtn = document.getElementById('addNewVehicleBtn');
        const newVehicleNoInput = document.getElementById('newVehicleNo');
        const newVehicleDateInput = document.getElementById('newVehicleDate');
        const vehicleTableBody = document.getElementById('vehicleTableBody');
        const vehicleSelectMainForm = document.getElementById('{{ form.Vehicle_No.id_for_label }}');
        const vehicleLoadingIndicator = document.getElementById('vehicleLoading');
        const vehicleMessage = document.getElementById('vehicleMessage');

        async function fetchAndRenderVehicles() {
            if (vehicleLoadingIndicator) vehicleLoadingIndicator.style.display = 'block'; // Added null check

            try {
                const response = await fetch('/vehicles/get/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    renderVehicles(data.vehicles);
                } else {
                    const errorMessage = data.message || (data.errors ? JSON.stringify(data.errors) : 'Unknown error');
                    console.error('Error fetching vehicles:', data.errors || data.message);
                }
            }
            catch (error) {
                console.error('Network error fetching vehicles:', error);
            } finally {
                if (vehicleLoadingIndicator) vehicleLoadingIndicator.style.display = 'none'; // Added null check
            }
        }

        function renderVehicles(vehicles) {
            if (vehicleTableBody) vehicleTableBody.innerHTML = ''; // Added null check
            if (vehicleSelectMainForm) vehicleSelectMainForm.innerHTML = '<option value="">Select a Vehicle No</option>'; // Added null check

            if (vehicles.length === 0) {
                if (vehicleTableBody) vehicleTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No vehicles added yet.</td></tr>'; // Added null check
            } else {
                let sNo = 1;
                vehicles.forEach(vehicle => {
                    const row = vehicleTableBody.insertRow();
                    row.insertCell(0).textContent = sNo++;
                    row.insertCell(1).textContent = vehicle.vehicle_number;
                    row.insertCell(2).textContent = vehicle.date_added;

                    const actionsCell = row.insertCell(3);
                    actionsCell.classList.add('actions');

                    const selectRowBtn = document.createElement('button');
                    selectRowBtn.innerHTML = '<i class="fa-solid fa-pencil"></i>';
                    selectRowBtn.classList.add('table-action-btn', 'select-btn');
                    selectRowBtn.title = `Select ${vehicle.vehicle_number}`;
                    selectRowBtn.setAttribute('data-vehicle-id', vehicle.id);
                    selectRowBtn.setAttribute('data-vehicle-number', vehicle.vehicle_number);
                    selectRowBtn.setAttribute('data-vehicle-date', vehicle.date_added);
                    actionsCell.appendChild(selectRowBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    deleteBtn.classList.add('table-action-btn', 'delete-btn');
                    deleteBtn.title = `Delete ${vehicle.vehicle_number}`;
                    deleteBtn.setAttribute('data-vehicle-id', vehicle.id);
                    actionsCell.appendChild(deleteBtn);

                    if (vehicleSelectMainForm) { // Added null check
                        const optionMainForm = document.createElement('option');
                        optionMainForm.value = vehicle.id;
                        optionMainForm.textContent = vehicle.vehicle_number;
                        vehicleSelectMainForm.appendChild(optionMainForm);
                    }
                });

                attachVehicleTableButtonListeners();
            }
        }

        function attachVehicleTableButtonListeners() {
            document.querySelectorAll('#vehicleTableBody .select-btn').forEach(button => {
                button.onclick = function () {
                    const selectedId = this.getAttribute('data-vehicle-id');
                    const selectedNum = this.getAttribute('data-vehicle-number');
                    const selectedDate = this.getAttribute('data-vehicle-date');

                    if (newVehicleNoInput) newVehicleNoInput.value = selectedNum; // Added null check
                    if (newVehicleDateInput) newVehicleDateInput.value = selectedDate; // Added null check
                    if (vehicleSelectMainForm) vehicleSelectMainForm.value = selectedId; // Added null check
                };
            });

            document.querySelectorAll('#vehicleTableBody .delete-btn').forEach(button => {
                button.onclick = async function () {
                    const vehicleId = this.getAttribute('data-vehicle-id');
                    showConfirmationModal("Are you sure you want to delete this vehicle?", async (confirmed) => {
                        if (confirmed) {
                            console.log(`Attempting to delete vehicle ID: ${vehicleId}`);
                            await deleteVehicle(vehicleId);
                        }
                    });
                };
            });
        }

        async function addNewVehicle() {
            const vehicleNo = newVehicleNoInput ? newVehicleNoInput.value.trim() : ''; // Added null check
            const dateAdded = newVehicleDateInput ? newVehicleDateInput.value : ''; // Added null check

            if (!vehicleNo || !dateAdded) {
                console.error("Vehicle Number and Date are required.");
                showSuccessPopup("Error: Vehicle Number and Date are required.");
                return;
            }

            if (vehicleLoadingIndicator) vehicleLoadingIndicator.style.display = 'block'; // Added null check
            if (addNewVehicleBtn) addNewVehicleBtn.disabled = true; // Added null check

            try {
                const payload = { vehicle_number: vehicleNo, date_added: dateAdded };
                console.log("Sending vehicle payload:", payload);
                const response = await fetch('/vehicles/add/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                console.log("Received vehicle response:", data);

                if (response.ok && data.success) {
                    showSuccessPopup("Vehicle added successfully!"); // Call for pop notification
                    if (newVehicleNoInput) newVehicleNoInput.value = ''; // Added null check
                    if (newVehicleDateInput) newVehicleDateInput.value = new Date().toISOString().slice(0, 10); // Added null check
                    if (vehicleModalOverlay) vehicleModalOverlay.style.display = 'none'; // Added null check
                    fetchAndRenderVehicles();
                } else {
                    let errorDetail = 'Unknown error';
                    if (data.message) errorDetail = data.message;
                    else if (data.errors) {
                        try {
                            const errors = JSON.parse(data.errors);
                            let errorMessages = [];
                            for (const field in errors) {
                                errors[field].forEach(err => { errorMessages.push(`${field}: ${err.message || err.code}`); });
                            }
                            errorDetail = errorMessages.join('; ');
                        } catch (e) {
                            errorDetail = data.errors;
                        }
                    }
                    console.error('Error adding vehicle:', data.errors || data.message || data);
                    showSuccessPopup(`Error adding vehicle: ${errorDetail}`);
                }
            }
            catch (error) {
                console.error('Network error adding vehicle:', error);
                showSuccessPopup(`Network error adding vehicle: ${error.message}`);
            } finally {
                if (vehicleLoadingIndicator) vehicleLoadingIndicator.style.display = 'none'; // Added null check
                if (addNewVehicleBtn) addNewVehicleBtn.disabled = false; // Added null check
            }
        }

        async function deleteVehicle(vehicleId) {
            if (vehicleLoadingIndicator) vehicleLoadingIndicator.style.display = 'block'; // Added null check

            try {
                const response = await fetch(`/vehicles/delete/${vehicleId}/`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccessPopup("Vehicle deleted successfully!");
                    fetchAndRenderVehicles();
                } else {
                    const errorMessage = data.message || (data.errors ? JSON.stringify(data.errors) : 'Unknown error');
                    console.error('Error deleting vehicle:', errorMessage);
                    showSuccessPopup(`Error deleting vehicle: ${errorMessage}`);
                }
            }
            catch (error) {
                console.error('Error deleting vehicle:', error);
                showSuccessPopup(`Network error deleting vehicle: ${error.message}`);
            } finally {
                if (vehicleLoadingIndicator) vehicleLoadingIndicator.style.display = 'none'; // Added null check
            }
        }


        // --- Consignee Management ---
        const addConsigneeBtn = document.getElementById('addConsigneeBtn');
        const consigneeModalOverlay = document.getElementById('consigneeModalOverlay');
        const closeConsigneeModalBtn = document.getElementById('closeConsigneeModalBtn');
        const addNewConsigneeBtn = document.getElementById('addNewConsigneeBtn');
        const newConsigneeNameInput = document.getElementById('newConsigneeName');
        const newConsigneeDateInput = document.getElementById('newConsigneeDate');
        const newConsigneeAddressInput = document.getElementById('newConsigneeAddress');
        const consigneeTableBody = document.getElementById('consigneeTableBody');
        const consigneeSelectMainForm = document.getElementById('{{ form.consignee.id_for_label }}');
        const consigneeLoadingIndicator = document.getElementById('consigneeLoading');

        async function fetchAndRenderConsignees() {
            if (consigneeLoadingIndicator) consigneeLoadingIndicator.style.display = 'block'; // Added null check

            try {
                const response = await fetch('/consignees/get/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    allConsignees = data.consignees; // Store fetched data globally
                    renderConsignees(allConsignees);
                } else {
                    const errorMessage = data.message || (data.errors ? JSON.stringify(data.errors) : 'Unknown error');
                    console.error('Error fetching consignees:', data.errors || data.message);
                }
            }
            catch (error) {
                console.error('Network error fetching consignees:', error);
            } finally {
                if (consigneeLoadingIndicator) consigneeLoadingIndicator.style.display = 'none'; // Added null check
            }
        }

        function renderConsignees(consignees) {
            if (consigneeTableBody) consigneeTableBody.innerHTML = ''; // Added null check
            if (consigneeSelectMainForm) consigneeSelectMainForm.innerHTML = '<option value="">Select Consignee</option>'; // Added null check

            if (consignees.length === 0) {
                if (consigneeTableBody) consigneeTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No consignees added yet.</td></tr>'; // Added null check
            } else {
                let sNo = 1;
                consignees.forEach(consignee => {
                    const row = consigneeTableBody.insertRow();
                    row.insertCell(0).textContent = sNo++;
                    row.insertCell(1).textContent = consignee.consignee_name;
                    row.insertCell(2).textContent = consignee.date_added;
                    row.insertCell(3).textContent = consignee.consignee_address;

                    const actionsCell = row.insertCell(4);
                    actionsCell.classList.add('actions');

                    const selectRowBtn = document.createElement('button');
                    selectRowBtn.innerHTML = '<i class="fa-solid fa-pencil"></i>';
                    selectRowBtn.classList.add('table-action-btn', 'select-btn');
                    selectRowBtn.title = `Select ${consignee.consignee_name}`;
                    selectRowBtn.setAttribute('data-consignee-id', consignee.id);
                    selectRowBtn.setAttribute('data-consignee-name', consignee.consignee_name);
                    selectRowBtn.setAttribute('data-consignee-date', consignee.date_added);
                    selectRowBtn.setAttribute('data-consignee-address', consignee.consignee_address);
                    actionsCell.appendChild(selectRowBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    deleteBtn.classList.add('table-action-btn', 'delete-btn');
                    deleteBtn.title = `Delete ${consignee.consignee_name}`;
                    deleteBtn.setAttribute('data-consignee-id', consignee.id);
                    actionsCell.appendChild(deleteBtn);

                    if (consigneeSelectMainForm) { // Added null check
                        const optionMainForm = document.createElement('option');
                        optionMainForm.value = consignee.id;
                        optionMainForm.textContent = consignee.consignee_name;
                        consigneeSelectMainForm.appendChild(optionMainForm);
                    }
                });

                attachConsigneeTableButtonListeners();
            }
        }

        function attachConsigneeTableButtonListeners() {
            document.querySelectorAll('#consigneeTableBody .select-btn').forEach(button => {
                button.onclick = function () {
                    const selectedId = this.getAttribute('data-consignee-id');
                    const selectedName = this.getAttribute('data-consignee-name');
                    const selectedDate = this.getAttribute('data-consignee-date');
                    const selectedAddress = this.getAttribute('data-consignee-address');

                    if (newConsigneeNameInput) newConsigneeNameInput.value = selectedName; // Added null check
                    if (newConsigneeDateInput) newConsigneeDateInput.value = selectedDate; // Added null check
                    if (newConsigneeAddressInput) newConsigneeAddressInput.value = selectedAddress; // Added null check
                    if (consigneeSelectMainForm) consigneeSelectMainForm.value = selectedId; // Added null check
                };
            });

            document.querySelectorAll('#consigneeTableBody .delete-btn').forEach(button => {
                button.onclick = async function () {
                    const consigneeId = this.getAttribute('data-consignee-id');
                    showConfirmationModal("Are you sure you want to delete this consignee?", async (confirmed) => {
                        if (confirmed) {
                            console.log(`Attempting to delete consignee ID: ${consigneeId}`);
                            await deleteConsignee(consigneeId);
                        }
                    });
                };
            });
        }

        async function addNewConsignee() {
            const consigneeName = newConsigneeNameInput ? newConsigneeNameInput.value.trim() : ''; // Added null check
            const dateAdded = newConsigneeDateInput ? newConsigneeDateInput.value : ''; // Added null check
            const consigneeAddress = newConsigneeAddressInput ? newConsigneeAddressInput.value.trim() : ''; // Added null check

            if (!consigneeName || !dateAdded || !consigneeAddress) {
                console.error("Consignee Name, Date, and Address are required.");
                showSuccessPopup("Error: Consignee Name, Date, and Address are required.");
                return;
            }

            if (consigneeLoadingIndicator) consigneeLoadingIndicator.style.display = 'block'; // Added null check
            if (addNewConsigneeBtn) addNewConsigneeBtn.disabled = true; // Added null check

            try {
                const response = await fetch('/consignees/add/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ consignee_name: consigneeName, date_added: dateAdded, consignee_address: consigneeAddress })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccessPopup("Consignee added successfully!"); // Call for pop notification
                    if (newConsigneeNameInput) newConsigneeNameInput.value = ''; // Added null check
                    if (newConsigneeDateInput) newConsigneeDateInput.value = new Date().toISOString().slice(0, 10); // Added null check
                    if (consigneeModalOverlay) consigneeModalOverlay.style.display = 'none'; // Added null check
                    if (newConsigneeAddressInput) newConsigneeAddressInput.value = ''; // Added null check
                    await fetchAndRenderConsignees();
                } else {
                    let errorDetail = 'Unknown error';
                    if (data.message) errorDetail = data.message;
                    else if (data.errors) {
                        try {
                            const errors = JSON.parse(data.errors);
                            let errorMessages = [];
                            for (const field in errors) {
                                errors[field].forEach(err => { errorMessages.push(`${field}: ${err.message || err.code}`); });
                            }
                            errorDetail = errorMessages.join('; ');
                        } catch (e) {
                            errorDetail = data.errors;
                        }
                    }
                    console.error('Error adding consignee:', data.errors || data.message || data);
                    showSuccessPopup(`Error adding consignee: ${errorDetail}`);
                }
            }
            catch (error) {
                console.error('Error adding consignee:', error);
                showSuccessPopup(`Network error adding consignee: ${error.message}`);
            } finally {
                if (consigneeLoadingIndicator) consigneeLoadingIndicator.style.display = 'none'; // Added null check
                if (addNewConsigneeBtn) addNewConsigneeBtn.disabled = false; // Added null check
            }
        }

        async function deleteConsignee(consigneeId) {
            if (consigneeLoadingIndicator) consigneeLoadingIndicator.style.display = 'block'; // Added null check

            try {
                const response = await fetch(`/consignees/delete/${consigneeId}/`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccessPopup("Consignee deleted successfully!");
                    fetchAndRenderConsignees();
                } else {
                    const errorMessage = data.message || (data.errors ? JSON.stringify(data.errors) : 'Unknown error');
                    console.error('Error deleting consignee:', errorMessage);
                    showSuccessPopup(`Error deleting consignee: ${errorMessage}`);
                }
            }
            catch (error) {
                console.error('Error deleting consignee:', error);
                showSuccessPopup(`Network error deleting consignee: ${error.message}`);
            } finally {
                if (consigneeLoadingIndicator) consigneeLoadingIndicator.style.display = 'none'; // Added null check
            }
        }


        // --- Consigner Management ---
        const addConsignerBtn = document.getElementById('addConsignerBtn');
        const consignerModalOverlay = document.getElementById('consignerModalOverlay');
        const closeConsignerModalBtn = document.getElementById('closeConsignerModalBtn');
        const addNewConsignerBtn = document.getElementById('addNewConsignerBtn');
        const newConsignerNameInput = document.getElementById('newConsignerName');
        const newConsignerDateInput = document.getElementById('newConsignerDate');
        const newConsignerAddressInput = document.getElementById('newConsignerAddress');
        const consignerTableBody = document.getElementById('consignerTableBody');
        const consignerSelectMainForm = document.getElementById('{{ form.consigner.id_for_label }}');
        const consignerLoadingIndicator = document.getElementById('consignerLoading');

        async function fetchAndRenderConsigners() {
            if (consignerLoadingIndicator) consignerLoadingIndicator.style.display = 'block'; // Added null check

            try {
                const response = await fetch('/consigners/get/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    allConsigners = data.consigners; // Store fetched data globally
                    renderConsigners(allConsigners);
                } else {
                    const errorMessage = data.message || (data.errors ? JSON.stringify(data.errors) : 'Unknown error');
                    console.error('Error fetching consigners:', data.errors || data.message);
                }
            }
            catch (error) {
                console.error('Network error fetching consigners:', error);
            } finally {
                if (consignerLoadingIndicator) consignerLoadingIndicator.style.display = 'none'; // Added null check
            }
        }

        function renderConsigners(consigners) {
            if (consignerTableBody) consignerTableBody.innerHTML = ''; // Added null check
            if (consignerSelectMainForm) consignerSelectMainForm.innerHTML = '<option value="">Select Consignor</option>'; // Added null check

            if (consigners.length === 0) {
                if (consignerTableBody) consignerTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No consigners added yet.</td></tr>'; // Added null check
            } else {
                let sNo = 1;
                consigners.forEach(consigner => {
                    const row = consignerTableBody.insertRow();
                    row.insertCell(0).textContent = sNo++;
                    row.insertCell(1).textContent = consigner.consigner_name;
                    row.insertCell(2).textContent = consigner.date_added;
                    row.insertCell(3).textContent = consigner.consigner_address;

                    const actionsCell = row.insertCell(4);
                    actionsCell.classList.add('actions');

                    const selectRowBtn = document.createElement('button');
                    selectRowBtn.innerHTML = '<i class="fa-solid fa-pencil"></i>';
                    selectRowBtn.classList.add('table-action-btn', 'select-btn');
                    selectRowBtn.title = `Select ${consigner.consigner_name}`;
                    selectRowBtn.setAttribute('data-consigner-id', consigner.id);
                    selectRowBtn.setAttribute('data-consigner-name', consigner.consigner_name);
                    selectRowBtn.setAttribute('data-consigner-date', consigner.date_added);
                    selectRowBtn.setAttribute('data-consigner-address', consigner.consigner_address);
                    actionsCell.appendChild(selectRowBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    deleteBtn.classList.add('table-action-btn', 'delete-btn');
                    deleteBtn.title = `Delete ${consigner.consigner_name}`;
                    deleteBtn.setAttribute('data-consigner-id', consigner.id);
                    actionsCell.appendChild(deleteBtn);

                    if (consignerSelectMainForm) { // Added null check
                        const optionMainForm = document.createElement('option');
                        optionMainForm.value = consigner.id;
                        optionMainForm.textContent = consigner.consigner_name;
                        consignerSelectMainForm.appendChild(optionMainForm);
                    }
                });

                attachConsignerTableButtonListeners();
            }
        }

        function attachConsignerTableButtonListeners() {
            document.querySelectorAll('#consignerTableBody .select-btn').forEach(button => {
                button.onclick = function () {
                    const selectedId = this.getAttribute('data-consigner-id');
                    const selectedName = this.getAttribute('data-consigner-name');
                    const selectedDate = this.getAttribute('data-consigner-date');
                    const selectedAddress = this.getAttribute('data-consigner-address');

                    if (newConsignerNameInput) newConsignerNameInput.value = selectedName; // Added null check
                    if (newConsignerDateInput) newConsignerDateInput.value = selectedDate; // Added null check
                    if (newConsignerAddressInput) newConsignerAddressInput.value = selectedAddress; // Added null check
                    if (consignerSelectMainForm) consignerSelectMainForm.value = selectedId; // Added null check
                };
            });

            document.querySelectorAll('#consignerTableBody .delete-btn').forEach(button => {
                button.onclick = async function () {
                    const consignerId = this.getAttribute('data-consigner-id');
                    showConfirmationModal("Are you sure you want to delete this consigner?", async (confirmed) => {
                        if (confirmed) {
                            console.log(`Attempting to delete consigner ID: ${consignerId}`);
                            await deleteConsigner(consignerId);
                        }
                    });
                };
            });
        }

        async function addNewConsigner() {
            const consignerName = newConsignerNameInput ? newConsignerNameInput.value.trim() : ''; // Added null check
            const dateAdded = newConsignerDateInput ? newConsignerDateInput.value : ''; // Added null check
            const consignerAddress = newConsignerAddressInput ? newConsignerAddressInput.value.trim() : ''; // Added null check

            if (!consignerName || !dateAdded || !consignerAddress) {
                console.error("Consigner Name, Date, and Address are required.");
                showSuccessPopup("Error: Consigner Name, Date, and Address are required.");
                return;
            }

            if (consignerLoadingIndicator) consignerLoadingIndicator.style.display = 'block'; // Added null check
            if (addNewConsignerBtn) addNewConsignerBtn.disabled = true; // Added null check

            try {
                const response = await fetch('/consigners/add/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ consigner_name: consignerName, date_added: dateAdded, consigner_address: consignerAddress })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccessPopup("Consigner added successfully!"); // Call for pop notification
                    if (newConsignerNameInput) newConsignerNameInput.value = ''; // Added null check
                    if (newConsignerDateInput) newConsignerDateInput.value = new Date().toISOString().slice(0, 10); // Added null check
                    if (consignerModalOverlay) consignerModalOverlay.style.display = 'none'; // Added null check
                    if (newConsignerAddressInput) newConsignerAddressInput.value = ''; // Added null check
                    await fetchAndRenderConsigners();
                } else {
                    let errorDetail = 'Unknown error';
                    if (data.message) errorDetail = data.message;
                    else if (data.errors) {
                        try {
                            const errors = JSON.parse(data.errors);
                            let errorMessages = [];
                            for (const field in errors) {
                                errors[field].forEach(err => { errorMessages.push(`${field}: ${err.message || err.code}`); });
                            }
                            errorDetail = errorMessages.join('; ');
                        } catch (e) {
                            errorDetail = data.errors;
                        }
                    }
                    console.error('Error adding consigner:', data.errors || data.message || data);
                    showSuccessPopup(`Error adding consigner: ${errorDetail}`);
                }
            }
            catch (error) {
                console.error('Error adding consigner:', error);
                showSuccessPopup(`Network error adding consigner: ${error.message}`);
            } finally {
                if (consignerLoadingIndicator) consignerLoadingIndicator.style.display = 'none'; // Added null check
                if (addNewConsignerBtn) addNewConsignerBtn.disabled = false; // Added null check
            }
        }

        async function deleteConsigner(consignerId) {
            if (consignerLoadingIndicator) consignerLoadingIndicator.style.display = 'block'; // Added null check

            try {
                const response = await fetch(`/consigners/delete/${consignerId}/`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccessPopup("Consigner deleted successfully!");
                    fetchAndRenderConsigners();
                } else {
                    const errorMessage = data.message || (data.errors ? JSON.stringify(data.errors) : 'Unknown error');
                    console.error('Error deleting consigner:', errorMessage);
                    showSuccessPopup(`Error deleting consigner: ${errorMessage}`);
                }
            }
            catch (error) {
                console.error('Error deleting consigner:', error);
                showSuccessPopup(`Network error deleting consigner: ${error.message}`);
            } finally {
                if (consignerLoadingIndicator) consignerLoadingIndicator.style.display = 'none'; // Added null check
            }
        }


        // --- Location Management (NEW) ---
        const addFromLocationBtn = document.getElementById('addFromLocationBtn');
        const addToLocationBtn = document.getElementById('addToLocationBtn');
        const locationModalOverlay = document.getElementById('locationModalOverlay');
        const closeLocationModalBtn = document.getElementById('closeLocationModalBtn');
        const addNewLocationBtn = document.getElementById('addNewLocationBtn');
        const newLocationNameInput = document.getElementById('newLocationName');
        const newLocationDateInput = document.getElementById('newLocationDate');
        const locationTableBody = document.getElementById('locationTableBody');
        const fromLocationSelect = document.getElementById('{{ form.from_location.id_for_label }}');
        const toLocationSelect = document.getElementById('{{ form.To_Location.id_for_label }}');
        const locationLoadingIndicator = document.getElementById('locationLoading');

        async function fetchAndRenderLocations() {
            if (locationLoadingIndicator) locationLoadingIndicator.style.display = 'block'; // Added null check

            try {
                const response = await fetch('/locations/get/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    renderLocations(data.locations);
                } else {
                    const errorMessage = data.message || (data.errors ? JSON.stringify(data.errors) : 'Unknown error');
                    console.error('Error fetching locations:', data.errors || data.message);
                }
            }
            catch (error) {
                console.error('Network error fetching locations:', error);
            } finally {
                if (locationLoadingIndicator) locationLoadingIndicator.style.display = 'none'; // Added null check
            }
        }

        function renderLocations(locations) {
            if (locationTableBody) locationTableBody.innerHTML = ''; // Added null check
            if (fromLocationSelect) fromLocationSelect.innerHTML = '<option value="">Select From Location</option>'; // Added null check
            if (toLocationSelect) toLocationSelect.innerHTML = '<option value="">Select To Location</option>'; // Added null check

            if (locations.length === 0) {
                if (locationTableBody) locationTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No locations added yet.</td></tr>'; // Added null check
            } else {
                let sNo = 1;
                locations.forEach(location => {
                    const row = locationTableBody.insertRow();
                    row.insertCell(0).textContent = sNo++;
                    row.insertCell(1).textContent = location.location_name;
                    row.insertCell(2).textContent = location.date_added;

                    const actionsCell = row.insertCell(3);
                    actionsCell.classList.add('actions');

                    const selectRowBtn = document.createElement('button');
                    selectRowBtn.innerHTML = '<i class="fa-solid fa-pencil"></i>';
                    selectRowBtn.classList.add('table-action-btn', 'select-btn');
                    selectRowBtn.title = `Select ${location.location_name}`;
                    selectRowBtn.setAttribute('data-location-id', location.id);
                    selectRowBtn.setAttribute('data-location-name', location.location_name);
                    selectRowBtn.setAttribute('data-location-date', location.date_added);
                    actionsCell.appendChild(selectRowBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    deleteBtn.classList.add('table-action-btn', 'delete-btn');
                    deleteBtn.title = `Delete ${location.location_name}`;
                    deleteBtn.setAttribute('data-location-id', location.id);
                    actionsCell.appendChild(deleteBtn);

                    if (fromLocationSelect) { // Added null check
                        const option = document.createElement('option');
                        option.value = location.id;
                        option.textContent = location.location_name;
                        fromLocationSelect.appendChild(option.cloneNode(true));
                    }
                    if (toLocationSelect) { // Added null check
                        const option = document.createElement('option');
                        option.value = location.id;
                        option.textContent = location.location_name;
                        toLocationSelect.appendChild(option);
                    }
                });
                attachLocationTableButtonListeners();
            }
        }

        function attachLocationTableButtonListeners() {
            document.querySelectorAll('#locationTableBody .select-btn').forEach(button => {
                button.onclick = function () {
                    const selectedId = this.getAttribute('data-location-id');
                    const selectedName = this.getAttribute('data-location-name');
                    const selectedDate = this.getAttribute('data-location-date');

                    if (newLocationNameInput) newLocationNameInput.value = selectedName; // Added null check
                    if (newLocationDateInput) newLocationDateInput.value = selectedDate; // Added null check
                    if (fromLocationSelect) fromLocationSelect.value = selectedId; // Added null check
                    if (toLocationSelect) toLocationSelect.value = selectedId; // Added null check
                };
            });

            document.querySelectorAll('#locationTableBody .delete-btn').forEach(button => {
                button.onclick = async function () {
                    const locationId = this.getAttribute('data-location-id');
                    showConfirmationModal("Are you sure you want to delete this location?", async (confirmed) => {
                        if (confirmed) {
                            console.log(`Attempting to delete location ID: ${locationId}`);
                            await deleteLocation(locationId);
                        }
                    });
                };
            });
        }

        async function addNewLocation() {
            const locationName = newLocationNameInput ? newLocationNameInput.value.trim() : ''; // Added null check
            const dateAdded = newLocationDateInput ? newLocationDateInput.value : ''; // Added null check

            if (!locationName || !dateAdded) {
                console.error("Location Name and Date are required.");
                showSuccessPopup("Error: Location Name and Date are required.");
                return;
            }

            if (locationLoadingIndicator) locationLoadingIndicator.style.display = 'block'; // Added null check
            if (addNewLocationBtn) addNewLocationBtn.disabled = true; // Added null check

            try {
                const payload = { location_name: locationName, date_added: dateAdded };
                console.log("Sending location payload:", payload);
                const response = await fetch('/locations/add/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccessPopup("Location added successfully!"); // Call for pop notification
                    if (newLocationNameInput) newLocationNameInput.value = ''; // Added null check
                    if (newLocationDateInput) newLocationDateInput.value = new Date().toISOString().slice(0, 10); // Added null check
                    if (locationModalOverlay) locationModalOverlay.style.display = 'none'; // Added null check
                    fetchAndRenderLocations();
                } else {
                    let errorDetail = 'Unknown error';
                    if (data.message) errorDetail = data.message;
                    else if (data.errors) {
                        try {
                            const errors = JSON.parse(data.errors);
                            let errorMessages = [];
                            for (const field in errors) {
                                errors[field].forEach(err => { errorMessages.push(`${field}: ${err.message || err.code}`); });
                            }
                            errorDetail = errorMessages.join('; ');
                        } catch (e) {
                            errorDetail = data.errors;
                        }
                    }
                    console.error('Error adding location:', data.errors || data.message || data);
                    showSuccessPopup(`Error adding location: ${errorDetail}`);
                }
            }
            catch (error) {
                console.error('Network error adding location:', error);
                showSuccessPopup(`Network error adding location: ${error.message}`);
            } finally {
                if (locationLoadingIndicator) locationLoadingIndicator.style.display = 'none'; // Added null check
                if (addNewLocationBtn) addNewLocationBtn.disabled = false; // Added null check
            }
        }

        async function deleteLocation(locationId) {
            if (locationLoadingIndicator) locationLoadingIndicator.style.display = 'block'; // Added null check

            try {
                const response = await fetch(`/locations/delete/${locationId}/`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccessPopup("Location deleted successfully!");
                    fetchAndRenderLocations();
                } else {
                    const errorMessage = data.message || (data.errors ? JSON.stringify(data.errors) : 'Unknown error');
                    console.error('Error deleting location:', errorMessage);
                    showSuccessPopup(`Error deleting location: ${errorMessage}`);
                }
            }
            catch (error) {
                console.error('Error deleting location:', error);
                showSuccessPopup(`Network error deleting location: ${error.message}`);
            } finally {
                if (locationLoadingIndicator) locationLoadingIndicator.style.display = 'none'; // Added null check
            }
        }


        // --- Goods Information Table Management ---
        const goodsTableBody = document.getElementById('goodsTableBody');
        const addGoodsItemBtn = document.getElementById('addGoodsItemBtn');

        function renderGoodsItemsTable() {
            if (!goodsTableBody) return; // Ensure goodsTableBody exists

            goodsTableBody.innerHTML = '';

            // If no actual goods items exist, show an example row
            if (goodsItemsData.length === 0) {
                const row = goodsTableBody.insertRow();
                row.innerHTML = `
            <tr class="example-row" style="background-color: #fff3cd;">
                <td><input type="text" placeholder="Unit" disabled></td>
                <td><input type="number" placeholder="Quantity" disabled value="0"></td> <!-- Added default value -->
                <td><input type="number" placeholder="Rate" disabled value="0"></td>     <!-- Added default value -->
                <td><input type="number" placeholder="Amount" disabled value="0"></td>  <!-- Added default value -->
                <td><input type="text" placeholder="From Party" disabled></td>
                <td><input type="text" placeholder="To Party" disabled></td>
                <td style="text-align: center; color: #999;">Example</td>
            </tr>
        `;
                return; // Do not render other items or total row if no data
            }

            // Render existing goods items
            goodsItemsData.forEach((item, index) => {
                // Calculate GI Amount dynamically
                const quantity = parseFloat(item.quantity) || 0;
                const rate = parseFloat(item.rate) || 0;
                const giAmount = (quantity * rate).toFixed(2);

                const fromPartyOptions = allConsignees.map(consignee =>
                    `<option value="${consignee.id}" ${item.from_party == consignee.id ? 'selected' : ''}>${consignee.consignee_name}</option>`
                ).join('');

                const toPartyOptions = allConsigners.map(consigner =>
                    `<option value="${consigner.id}" ${item.to_party == consigner.id ? 'selected' : ''}>${consigner.consigner_name}</option>`
                ).join('');

                const row = goodsTableBody.insertRow();
                row.innerHTML = `
                        <td>
                            <select data-field="unit" data-index="${index}">
                                <option value="">Select</option>
                                <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>10 KG</option>
                                <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>15 KG</option>
                                <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>20 KG</option>
                            </select>
                        </td>
                        <td><input type="number" value="${item.quantity || 0}" data-field="quantity" data-index="${index}"></td>
                        <td><input type="number" value="${item.rate || 0}" data-field="rate" data-index="${index}"></td>
                        <td><input type="text" value="${giAmount}" disabled class="gi-amount-display" data-index="${index}"></td>
                        <td>
                            <select data-field="from_party" data-index="${index}">
                                <option value="">Select Consignee</option>
                                ${fromPartyOptions}
                            </select>
                        </td>
                        <td>
                            <select data-field="to_party" data-index="${index}">
                                <option value="">Select Consigner</option>
                                ${toPartyOptions}
                            </select>
                        </td>
                        <td style="white-space: nowrap;">
                            <button type="button" class="table-action-btn edit-goods-item-btn" data-index="${index}" title="Edit Item">
                                <i class="fa-solid fa-pencil"></i>
                            </button>
                            <button type="button" class="table-action-btn remove-goods-item-btn" data-index="${index}" title="Remove Item">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;

                // Update item on input/change
                row.querySelectorAll('input:not(.gi-amount-display), select').forEach(inputOrSelect => {
                    inputOrSelect.addEventListener('input', function () { // 'input' event works for both input and select elements
                        const itemIndex = parseInt(this.dataset.index);
                        const field = this.dataset.field;
                        
                        // Explicitly handle numeric fields to ensure they are numbers
                        if (field === 'quantity' || field === 'rate') {
                            goodsItemsData[itemIndex][field] = parseFloat(this.value) || 0;
                        } else if (field === 'from_party' || field === 'to_party') {
                            // This sends the ID (or null if empty string). Backend converts null/ID to name or empty string.
                            goodsItemsData[itemIndex][field] = this.value === '' ? null : this.value;
                        } else {
                            goodsItemsData[itemIndex][field] = this.value;
                        }

                        // Recalculate GI Amount if quantity or rate changed
                        if (field === 'quantity' || field === 'rate') {
                            const updatedQuantity = parseFloat(goodsItemsData[itemIndex].quantity) || 0;
                            const updatedRate = parseFloat(goodsItemsData[itemIndex].rate) || 0;
                            const updatedGI = (updatedQuantity * updatedRate); // Keep as number
                            const giField = goodsTableBody.rows[index].querySelector('.gi-amount-display');
                            if (giField) {
                                giField.value = updatedGI.toFixed(2); // Display as string with 2 decimal places
                                // Store the raw number in goodsItemsData, not a fixed-decimal string
                                goodsItemsData[itemIndex].amount = updatedGI; 
                            }
                        }
                        updateGoodsInfoHiddenField(); // Update hidden field on every input/change
                        updateGIAmountTotals(); // Call to update Total Fare Summary whenever GI Amount changes
                    });
                });

                row.querySelector('.edit-goods-item-btn').addEventListener('click', function () {
                    const itemIndex = parseInt(this.dataset.index);
                    const firstInput = goodsTableBody.rows[itemIndex].querySelector('input[data-field="quantity"]');
                    if (firstInput) {
                        firstInput.focus();
                    }
                });

                row.querySelector('.remove-goods-item-btn').addEventListener('click', function () {
                    const itemIndex = parseInt(this.dataset.index);
                    showConfirmationModal("Are you sure you want to remove this goods item?", (confirmed) => {
                        if (confirmed) {
                            console.log(`Removing goods item at index: ${itemIndex}`);
                            goodsItemsData.splice(itemIndex, 1);
                            updateGoodsInfoHiddenField();
                            renderGoodsItemsTable();
                            updateGIAmountTotals(); // Call to update Total Fare Summary when item is removed
                        }
                    });
                });
            });

            // Add the Total Fare summary row at the end of the tbody
            // Only add if goods items exist (excluding the example row)
            if (goodsItemsData.length > 0) {
                const totalFareRow = goodsTableBody.insertRow();
                totalFareRow.id = 'totalFareRow'; // Add an ID for easy selection
                totalFareRow.innerHTML = `
                    <td colspan="3" style="text-align: right; font-weight: bold; padding-right: 10px;">Total Fare:</td>
                    <td><input type="text" id="totalFareSummary" value="0.00" disabled style="width: calc(100% - 16px);"></td>
                    <td colspan="3"></td> <!-- Span for From Party, To Party, and Actions -->
                `;
                // Re-assign the global totalFareSummaryInput variable to the newly created element
                totalFareSummaryInput = document.getElementById('totalFareSummary');
                totalFareRow.style.display = ''; // Ensure it's shown if there are goods
            }

            updateGIAmountTotals(); // Call to update Total Fare Summary when table is rendered (e.g., on page load, data fetch)
        }

        function addGoodsItemRow() {
            const currentCnid = cnidInputField ? cnidInputField.value : ''; // Added null check
            if (!currentCnid || currentCnid === 'Error' || currentCnid === 'N/A') {
                showSuccessPopup("Please ensure a valid CNID is present before adding goods items. Refresh the page if needed.");
                return;
            }

            goodsItemsData.push({
                cnid: currentCnid, // Use current CNID
                unit: '',
                quantity: 0,   // Default to 0 for numbers
                rate: 0,       // Default to 0 for numbers
                amount: 0,     // Default to 0 for numbers
                from_party: null, // Default to null for FKs (ID will be sent as null/empty string)
                to_party: null    // Default to null for FKs (ID will be sent as null/empty string)
            });
            updateGoodsInfoHiddenField();
            renderGoodsItemsTable();
            // Remove the example row after the first actual item is added
            const exampleRow = document.querySelector('.goods-info-table .example-row');
            if (exampleRow && goodsItemsData.length > 0) {
                exampleRow.remove();
            }
            const newRowIndex = goodsItemsData.length - 1;
            // Focus on the first relevant input of the new row
            const newRowFirstInput = goodsTableBody.rows[newRowIndex].querySelector('input[data-field="quantity"]');
            if (newRowFirstInput) {
                newRowFirstInput.focus();
            }
            updateGIAmountTotals();
        }

        function updateGoodsInfoHiddenField() {
            if (goodsInfoHiddenInput) { // Added null check
                // Ensure all numeric values are numbers, and FKs are null or their ID
                // Note: The backend will handle conversion of null ID to empty string for CharField
                // Filter out items that are essentially empty (all values are default/null)
                const filteredGoodsData = goodsItemsData.filter(item => {
                    const quantity = parseFloat(item.quantity) || 0;
                    const rate = parseFloat(item.rate) || 0;
                    const unit = item.unit || '';
                    const fromParty = item.from_party || null;
                    const toParty = item.to_party || null;

                    // An item is considered "not empty" if any of its core fields are non-default
                    return quantity > 0 || rate > 0 || unit !== '' || fromParty !== null || toParty !== null;
                }).map(item => ({
                    ...item,
                    quantity: parseFloat(item.quantity) || 0,
                    rate: parseFloat(item.rate) || 0,
                    amount: parseFloat(item.amount) || 0,
                    from_party: item.from_party, // Send as is (null or ID)
                    to_party: item.to_party       // Send as is (null or ID)
                }));
                goodsInfoHiddenInput.value = JSON.stringify(filteredGoodsData);
            }
        }

        // Function to calculate total GI Amount and update Total Fare Summary
        function updateGIAmountTotals() {
            let totalGIAmount = 0;
            goodsItemsData.forEach(item => {
                // Ensure to sum only for items that are not considered empty for total fare calculation
                const quantity = parseFloat(item.quantity) || 0;
                const rate = parseFloat(item.rate) || 0;
                totalGIAmount += (quantity * rate);
            });

            const totalFareRow = document.getElementById('totalFareRow');
            if (totalFareSummaryInput && totalFareRow) {
                totalFareSummaryInput.value = totalGIAmount.toFixed(2);
                if (totalFareHiddenInput) { // Added null check
                    totalFareHiddenInput.value = totalGIAmount.toFixed(2);
                }

                // Show or hide the total fare row based on whether there are any actual goods items
                // or if there's any calculated amount
                // The filter logic for display should match the filter logic for sending to backend.
                const hasActualGoods = goodsItemsData.some(item => {
                    const quantity = parseFloat(item.quantity) || 0;
                    const rate = parseFloat(item.rate) || 0;
                    const unit = item.unit || '';
                    const fromParty = item.from_party || null;
                    const toParty = item.to_party || null;
                    return quantity > 0 || rate > 0 || unit !== '' || fromParty !== null || toParty !== null;
                });

                if (hasActualGoods || totalGIAmount > 0) {
                    totalFareRow.style.display = ''; // Show the row
                } else {
                    totalFareRow.style.display = 'none'; // Hide the row
                }
            }
        }


        // --- Event Listeners for Modals ---
        if (addVehicleBtn) { // Added null check
            addVehicleBtn.addEventListener('click', function () {
                if (vehicleModalOverlay) vehicleModalOverlay.style.display = 'flex'; // Added null check
                fetchAndRenderVehicles();
            });
        }

        if (closeVehicleModalBtn) { // Added null check
            closeVehicleModalBtn.addEventListener('click', function () {
                if (vehicleModalOverlay) vehicleModalOverlay.style.display = 'none'; // Added null check
            });
        }

        if (addNewVehicleBtn) { // Added null check
            addNewVehicleBtn.addEventListener('click', addNewVehicle);
        }

        // Consignee Modal Event Listeners
        if (addConsigneeBtn) { // Added null check
            addConsigneeBtn.addEventListener('click', function () {
                if (consigneeModalOverlay) consigneeModalOverlay.style.display = 'flex'; // Added null check
                if (newConsigneeNameInput) newConsigneeNameInput.value = ''; // Added null check
                if (newConsigneeDateInput) newConsigneeDateInput.value = new Date().toISOString().slice(0, 10); // Added null check
                if (newConsigneeAddressInput) newConsigneeAddressInput.value = ''; // Added null check
                fetchAndRenderConsignees();
            });
        }

        if (closeConsigneeModalBtn) { // Added null check
            closeConsigneeModalBtn.addEventListener('click', function () {
                if (consigneeModalOverlay) consigneeModalOverlay.style.display = 'none'; // Added null check
            });
        }

        if (addNewConsigneeBtn) { // Added null check
            addNewConsigneeBtn.addEventListener('click', addNewConsignee);
        }

        // Consigner Modal Event Listeners
        if (addConsignerBtn) { // Added null check
            addConsignerBtn.addEventListener('click', function () {
                if (consignerModalOverlay) consignerModalOverlay.style.display = 'flex'; // Added null check
                if (newConsignerNameInput) newConsignerNameInput.value = ''; // Added null check
                if (newConsignerDateInput) newConsignerDateInput.value = new Date().toISOString().slice(0, 10); // Added null check
                if (newConsignerAddressInput) newConsignerAddressInput.value = ''; // Added null check
                fetchAndRenderConsigners();
            });
        }

        if (closeConsignerModalBtn) { // Added null check
            closeConsignerModalBtn.addEventListener('click', function () {
                if (consignerModalOverlay) consignerModalOverlay.style.display = 'none'; // Added null check
            });
        }

        if (addNewConsignerBtn) { // Added null check
            addNewConsignerBtn.addEventListener('click', addNewConsigner);
        }

        // Location Modal Event Listeners
        if (addFromLocationBtn) { // Added null check
            addFromLocationBtn.addEventListener('click', function () {
                if (locationModalOverlay) locationModalOverlay.style.display = 'flex'; // Added null check
                if (newLocationNameInput) newLocationNameInput.value = ''; // Added null check
                if (newLocationDateInput) newLocationDateInput.value = new Date().toISOString().slice(0, 10); // Added null check
                fetchAndRenderLocations();
            });
        }

        if (addToLocationBtn) { // Added null check
            addToLocationBtn.addEventListener('click', function () {
                if (locationModalOverlay) locationModalOverlay.style.display = 'flex'; // Added null check
                if (newLocationNameInput) newLocationNameInput.value = ''; // Added null check
                if (newLocationDateInput) newLocationDateInput.value = new Date().toISOString().slice(0, 10); // Added null check
                fetchAndRenderLocations();
            });
        }

        if (closeLocationModalBtn) { // Added null check
            closeLocationModalBtn.addEventListener('click', function () {
                if (locationModalOverlay) locationModalOverlay.style.display = 'none'; // Added null check
            });
        }

        if (addNewLocationBtn) { // Added null check
            addNewLocationBtn.addEventListener('click', addNewLocation);
        }

        // Event listener for adding new goods item row
        if (addGoodsItemBtn) { // Added null check
            addGoodsItemBtn.addEventListener('click', addGoodsItemRow);
        }

        // --- Form Submission Interception ---
        if (consignmentForm) { // Added null check
            consignmentForm.addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent default form submission

                // Collect data from goods table and ensure correct types
                const currentGoodsData = [];
                let totalFareCalculated = 0;

                if (goodsTableBody) { // Added null check
                    goodsTableBody.querySelectorAll('tr:not(.example-row)').forEach(row => {
                        const unitInput = row.querySelector('[data-field="unit"]');
                        const quantityInput = row.querySelector('[data-field="quantity"]');
                        const rateInput = row.querySelector('[data-field="rate"]');
                        const giAmountDisplay = row.querySelector('.gi-amount-display'); // Get the displayed amount
                        const fromPartySelect = row.querySelector('[data-field="from_party"]');
                        const toPartySelect = row.querySelector('[data-field="to_party"]');

                        const unit = unitInput ? unitInput.value : '';
                        // Ensure quantity and rate are always numbers (0 if empty/invalid)
                        const quantity = parseFloat(quantityInput ? quantityInput.value : '0') || 0;
                        const rate = parseFloat(rateInput ? rateInput.value : '0') || 0;
                        // Use the internally calculated amount (as a number)
                        const amount = parseFloat(giAmountDisplay ? giAmountDisplay.value : '0') || 0;
                        
                        // Explicitly send null if no option is selected for ForeignKey fields (IDs)
                        const fromParty = fromPartySelect && fromPartySelect.value !== '' ? fromPartySelect.value : null;
                        const toParty = toPartySelect && toPartySelect.value !== '' ? toPartySelect.value : null;

                        currentGoodsData.push({
                            unit: unit,
                            quantity: quantity,
                            rate: rate,
                            amount: amount, // 'amount' is now a number
                            from_party: fromParty, // This will be null or an ID string
                            to_party: toParty      // This will be null or an ID string
                        });
                        totalFareCalculated += amount; // Sum the actual numeric amount
                    });
                }

                // FILTER OUT EMPTY GOODS ITEMS HERE BEFORE STRINGIFYING
                const filteredGoodsData = currentGoodsData.filter(item => {
                    const quantity = parseFloat(item.quantity) || 0;
                    const rate = parseFloat(item.rate) || 0;
                    const unit = item.unit || '';
                    const fromParty = item.from_party || null;
                    const toParty = item.to_party || null;

                    // An item is considered "not empty" if any of its core fields are non-default
                    return quantity > 0 || rate > 0 || unit !== '' || fromParty !== null || toParty !== null;
                });


                // Set the value of the hidden goods_info input with filtered data
                if (goodsInfoHiddenInput) { // Added null check
                    goodsInfoHiddenInput.value = JSON.stringify(filteredGoodsData);
                }
                // Set the value of the hidden total_fare input
                if (totalFareHiddenInput) { // Added null check
                    totalFareHiddenInput.value = totalFareCalculated.toFixed(2);
                }

                const formData = new FormData(consignmentForm);
                const payload = {};
                formData.forEach((value, key) => {
                    // Convert numeric fields to numbers where appropriate
                    if (['consignee', 'consigner', 'from_location', 'To_Location', 'Vehicle_No'].includes(key)) {
                        payload[key] = value ? parseInt(value) : null; // Send ID or null
                    } else if (key === 'cn_note_id') {
                        payload[key] = parseInt(value);
                    } else if (['Truck_Freight', 'Advance_Amount', 'Balance_Amount', 'Innam', 'Extra_TF'].includes(key)) {
                        payload[key] = parseFloat(value) || 0.00;
                    } else if (key === 'total_fare') { // Handle total_fare specifically to ensure it's a float from the calculated value
                        payload[key] = parseFloat(value) || 0.00;
                    }
                     else {
                        payload[key] = value;
                    }
                });

                // Add the goods_info JSON string manually since it's a hidden input.
                // This ensures the explicitly structured goods_info is sent.
                if (goodsInfoHiddenInput) { // Added null check
                    payload['goods_info'] = goodsInfoHiddenInput.value;
                }
                // total_fare is handled by the formData.forEach for the hidden input.


                fetch(consignmentForm.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify(payload),
                })
                    .then(response => {
                        // Check if the response is valid JSON before parsing
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            return response.json();
                        } else {
                            // If not JSON, it might be an HTML error page or empty response
                            console.error("Server did not return JSON. Response:", response.text());
                            throw new TypeError("Oops, server did not return JSON!");
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            showSuccessPopup("Consignment Form saved successfully!"); // Call for pop notification
                            // Clear the main form fields for a new entry
                            if (cnidInputField) cnidInputField.value = ''; // Added null check
                            const cnNoInput = document.getElementById('{{ form.Cn_No.id_for_label }}');
                            if (cnNoInput) cnNoInput.value = ''; // Added null check

                            // Clear select dropdowns by setting their value to the default empty option
                            const vehicleSelectElement = document.getElementById('{{ form.Vehicle_No.id_for_label }}');
                            if (vehicleSelectElement) vehicleSelectElement.value = ''; // Added null check
                            const consigneeSelectElement = document.getElementById('{{ form.consignee.id_for_label }}');
                            if (consigneeSelectElement) consigneeSelectElement.value = ''; // Added null check
                            const consignerSelectElement = document.getElementById('{{ form.consigner.id_for_label }}');
                            if (consignerSelectElement) consignerSelectElement.value = ''; // Added null check
                            const fromLocationSelectElement = document.getElementById('{{ form.from_location.id_for_label }}');
                            if (fromLocationSelectElement) fromLocationSelectElement.value = ''; // Added null check
                            const toLocationSelectElement = document.getElementById('{{ form.To_Location.id_for_label }}');
                            if (toLocationSelectElement) toLocationSelectElement.value = ''; // Added null check


                            // Clear date input fields
                            const bookingDateInput = document.getElementById('{{ form.Booking_Date.id_for_label }}');
                            if (bookingDateInput) bookingDateInput.value = ''; // Added null check
                            const loadingDateInput = document.getElementById('{{ form.Loading_Date.id_for_label }}');
                            if (loadingDateInput) loadingDateInput.value = ''; // Added null check
                            const unloadingDateInput = document.getElementById('{{ form.Unloading_Date.id_for_label }}');
                            if (unloadingDateInput) unloadingDateInput.value = ''; // Added null check

                            // Clear other financial fields
                            const truckFreightInputElement = document.getElementById('{{ form.Truck_Freight.id_for_label }}');
                            if (truckFreightInputElement) truckFreightInputElement.value = ''; // Added null check
                            const advanceAmountInput = document.getElementById('{{ form.Advance_Amount.id_for_label }}');
                            if (advanceAmountInput) advanceAmountInput.value = ''; // Added null check
                            const balanceAmountInput = document.getElementById('{{ form.Balance_Amount.id_for_label }}');
                            if (balanceAmountInput) balanceAmountInput.value = ''; // Added null check
                            const innamInput = document.getElementById('{{ form.Innam.id_for_label }}');
                            if (innamInput) innamInput.value = ''; // Added null check
                            const extraTfInput = document.getElementById('{{ form.Extra_TF.id_for_label }}');
                            if (extraTfInput) extraTfInput.value = ''; // Added null check

                            // Clear the new Total Fare summary field and hidden input
                            if (totalFareSummaryInput) {
                                totalFareSummaryInput.value = '0.00';
                            }
                            if (totalFareHiddenInput) {
                                totalFareHiddenInput.value = '0.00';
                            }

                            fetchAndDisplayNextCNID();
                            goodsItemsData = []; // Clear goods data
                            renderGoodsItemsTable(); // This will also trigger re-rendering with example row
                        } else {
                            let errorMessages = "Error saving form: ";
                            if (data.errors) {
                                try {
                                    // Assuming data.errors might be a JSON string of errors
                                    const errors = JSON.parse(data.errors);
                                    for (const field in errors) {
                                        if (Array.isArray(errors[field])) {
                                            errors[field].forEach(err => {
                                                errorMessages += `\n${field}: ${err.message || err.code || err}`;
                                            });
                                        } else {
                                            errorMessages += `\n${field}: ${errors[field]}`;
                                        }
                                    }
                                } catch (e) {
                                    // If parsing fails, use data.errors as a direct string
                                    errorMessages += data.errors;
                                }
                            } else if (data.message) {
                                errorMessages += data.message;
                            }
                            console.error('Form submission error:', errorMessages);
                            showSuccessPopup(`Error saving form: ${errorMessages}`);
                        }
                    })
                    .catch(error => {
                        console.error('Network error during form submission:', error);
                        showSuccessPopup(`Network error during form submission: ${error.message}`);
                    });
            });
        }


        // --- Smooth Scrolling for Master Dropdown Links ---
        document.querySelectorAll('.dropdown-content a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();

                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);

                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    targetElement.style.transition = 'outline 0.3s ease-in-out';
                    targetElement.style.outline = '2px solid #6a1b9a';
                    setTimeout(() => {
                        targetElement.style.outline = 'none';
                    }, 2000);
                }
            });
        });


        // Initial fetches on page load for the main form's dropdowns
        fetchAndRenderVehicles();
        fetchAndRenderConsignees(); // Fetch consignee data
        fetchAndRenderConsigners(); // Fetch consigner data
        fetchAndRenderLocations();
        fetchAndDisplayNextCNID(); // Ensure CNID is fetched at page load

        // Initial render of the goods information table (will be empty initially)
        renderGoodsItemsTable(); // This will also trigger initial Total Fare summary calculation
    });
</script>
</body>
{% endblock %}

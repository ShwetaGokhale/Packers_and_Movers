{% extends "base.html" %}
{% block content %}
  <style>
    footer {
      position: fixed;
      bottom: -100px;
      left: 0;
      width: 100%;
      background-color: #6a1b9a;
      color: white;
      text-align: center;
      padding: 8px 0;
      font-size: 12px;
      transition: bottom 0.4s ease;
      z-index: 50;
    }
    footer.show { bottom: 0; }
  </style>

<main class="flex-1 w-full max-w-7xl px-4 py-6 mx-auto">
  <h1 class="text-2xl font-bold text-gray-800 mb-6 ml-4">Financial Summary</h1>

  <form method="GET" class="flex flex-wrap items-end gap-4 mb-8 ml-6">
    <div>
      <label for="year" class="block text-sm font-medium text-gray-700">Select Year</label>
      <select name="year" id="year" class="mt-1 block w-32 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
        {% for y in years %}
          <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <button type="submit" class="h-10 mt-auto bg-purple-700 text-white px-5 py-2 rounded hover:bg-purple-800 shadow-md transition duration-200">Filter</button>
  </form>

  {% load humanize %}
  <!-- Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 px-4 mb-8">
    <div class="bg-white p-5 rounded-lg border-l-4 border-green-600 shadow hover:shadow-lg hover:scale-105 transition-transform duration-300">
      <h2 class="text-lg font-semibold text-gray-700">Advance Amount</h2>
      <p class="text-3xl font-bold text-green-700 mt-2">₹ {{ summary.total_advance|floatformat:2|intcomma }}</p>
    </div>
    <div class="bg-white p-5 rounded-lg border-l-4 border-red-600 shadow hover:shadow-lg hover:scale-105 transition-transform duration-300">
      <h2 class="text-lg font-semibold text-gray-700">Balance Amount</h2>
      <p class="text-3xl font-bold text-red-700 mt-2">₹ {{ summary.total_balance|floatformat:2|intcomma }}</p>
    </div>
    <div class="bg-white p-5 rounded-lg border-l-4 border-purple-600 shadow hover:shadow-lg hover:scale-105 transition-transform duration-300">
      <h2 class="text-lg font-semibold text-gray-700">Total Fare</h2>
      <p class="text-3xl font-bold text-purple-700 mt-2">₹ {{ summary.total_fare|floatformat:2|intcomma }}</p>
    </div>
  </div>

  <!-- Monthly Bar Chart -->
  <div class="bg-white p-5 rounded-lg shadow mb-8">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Month-wise Summary - {{ selected_year }}</h2>

    {% if summary.total_fare %}
      <canvas id="monthlyBarChart" height="100"></canvas>
    {% else %}
      <p class="text-center text-gray-500 mt-10">No data available for {{ selected_year }}.</p>
    {% endif %}
  </div>

  <!-- Consignee-wise Table -->
  <div class="bg-white p-5 rounded-lg shadow mb-10">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Consignee-wise Totals - {{ selected_year }}</h2>
    {% if consignee_totals %}
      <div class="overflow-x-auto max-h-96 overflow-y-auto">
        <table class="min-w-full bg-white border rounded-lg">
          <thead class="bg-purple-100 sticky top-0 z-10">
            <tr>
              <th class="text-left px-4 py-2">Consignee</th>
              <th class="text-right px-4 py-2">Advance Amount (₹)</th>
              <th class="text-right px-4 py-2">Balance Amount (₹)</th>
              <th class="text-right px-4 py-2">Total Fare (₹)</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consignee_totals %}
            <tr class="border-t">
              <td class="px-4 py-2">{{ c.consignee__consignee_name }}</td>
              <td class="px-4 py-2 text-right">{{ c.total_advance|floatformat:2|intcomma }}</td>
              <td class="px-4 py-2 text-right">{{ c.total_balance|floatformat:2|intcomma }}</td>
              <td class="px-4 py-2 text-right">{{ c.total_fare|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-gray-500 text-center mt-4">No consignee data available.</p>
    {% endif %}
  </div>
</main>

<!-- Footer -->
<footer id="pageFooter">
  <div><strong>Contact Us:</strong> support@infimetrics.com | +91-9876543210</div>
  <div class="text-xs text-white/80">&copy; 2025 Infimetrics IT Solutions Pvt. Ltd. All rights reserved.</div>
</footer>

<!-- JS -->
<script>
  function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
      window.location.href = "{% url 'logout' %}";
    }
  }

  document.addEventListener('mousemove', (e) => {
    const footer = document.getElementById("pageFooter");
    if (window.innerHeight - e.clientY < 60) {
      footer.classList.add('show');
    } else {
      footer.classList.remove('show');
    }
  });

  window.onload = function () {
    try {
      const monthLabels = JSON.parse('{{ month_labels|escapejs }}');
      const advanceValues = JSON.parse('{{ advance_values|escapejs }}');
      const balanceValues = JSON.parse('{{ balance_values|escapejs }}');
      const fareValues = JSON.parse('{{ fare_values|escapejs }}');

      if (monthLabels.length > 0) {
        const ctx = document.getElementById('monthlyBarChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: monthLabels,
            datasets: [
              {
                label: 'Advance Amount',
                data: advanceValues,
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderRadius: 5,
                barThickness: 25
              },
              {
                label: 'Balance Amount',
                data: balanceValues,
                backgroundColor: 'rgba(255, 99, 132, 0.8)',
                borderRadius: 5,
                barThickness: 25
              },
              {
                label: 'Total Fare',
                data: fareValues,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderRadius: 5,
                barThickness: 25
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Monthly Financial Totals'
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.dataset.label}: ₹${context.raw.toLocaleString()}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Amount (₹)'
                }
              }
            }
          }
        });
      }
    } catch (e) {
      console.error("Chart loading error:", e);
    }
  };
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<style>
    .table-container {
        background-color: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(106, 27, 154, 0.2);
        margin: 32px auto;
        width: 95%;
        max-width: 100%;
        overflow-x: auto;
    }

    h2 {
        color: #6a1b9a;
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        animation: slideUp 0.5s ease forwards;
    }

    .add-btn {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1rem;
        transition: background 0.3s ease;
    }

    .add-btn:hover {
        background-color: #388e3c;
    }

    /* Smart Dropdown Container */
    .dropdown-container {
        position: relative;
        width: 100%;
        max-width: 320px;
    }

    .dropdown-input {
        width: 100%;
        padding: 10px 16px;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        background-color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .dropdown-input:focus {
        outline: none;
        border-color: #6a1b9a;
        box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.1);
    }

    .dropdown-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        transition: transform 0.3s ease;
        color: #6b7280;
    }

    .dropdown-arrow.rotate {
        transform: translateY(-50%) rotate(180deg);
    }

    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #fff;
        border: 2px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .dropdown-list.show {
        display: block;
    }

    .dropdown-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .dropdown-item:hover {
        background-color: #f9fafb;
    }

    .dropdown-item.highlighted {
        background-color: #6a1b9a;
        color: white;
    }

    .dropdown-item:last-child {
        border-bottom: none;
    }

    .clear-button {
        position: absolute;
        right: 35px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #9ca3af;
        padding: 2px;
        display: none;
    }

    .clear-button:hover {
        color: #6b7280;
    }

    .clear-button.show {
        display: block;
    }

    .no-results {
        padding: 12px 16px;
        color: #9ca3af;
        font-style: italic;
        text-align: center;
    }



    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        min-width: 1000px;
    }

    th,
    td {
        padding: 12px;
        text-align: center;
        border: 1px solid #ddd;
        animation: slideUp 0.5s ease forwards;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    th {
        background-color: #6a1b9a;
        color: white;
        text-transform: uppercase;
    }

    .actions-column {
        display: flex;
        gap: 20px;
        justify-content: center;
    }

    .edit-btn,
    .delete-btn {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        font-size: 1.2em;
        transition: transform 0.2s, color 0.2s;
    }

    .edit-btn {
        color: #FFC107;
    }

    .edit-btn:hover {
        color: #FFA000;
        transform: scale(1.1);
    }

    .delete-btn {
        color: #f44336;
    }

    .delete-btn:hover {
        color: #d32f2f;
        transform: scale(1.1);
    }

    /* Modal Overlay Styles (Enhanced) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
        animation: fadeInOverlay 0.3s forwards;
    }

    .modal-content {
        background: linear-gradient(135deg, #f0f4f8, #e9ecf0);
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 450px;
        position: relative;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        animation: slideInModal 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        border: 1px solid #dcdcdc;
    }

    @keyframes fadeInOverlay {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideInModal {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-content h3 {
        text-align: center;
        color: #6a1b9a;
        margin-bottom: 25px;
        font-size: 1.8em;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
    }

    .modal-form-group {
        margin-bottom: 20px;
    }

    .modal-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #444;
        font-size: 0.95rem;
    }

    .modal-form-group input,
    .modal-form-group select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 30px;
        cursor: pointer;
        color: #777;
        transition: color 0.2s ease, transform 0.2s ease;
    }

    .modal-close-btn:hover {
        color: #333;
        transform: rotate(90deg);
    }

    .modal-add-btn {
        display: block;
        width: 100%;
        padding: 14px;
        background: linear-gradient(to right, #8e24aa, #6a1b9a);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        letter-spacing: 0.5px;
    }

    .modal-add-btn:hover {
        background: linear-gradient(to left, #8e24aa, #6a1b9a);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    #deleteModalOverlay .modal-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        max-width: 400px;
    }

    #deleteModalOverlay h3 {
        color: #d32f2f;
        font-size: 1.6em;
    }

    #deleteModalOverlay .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 25px;
    }

    #deleteModalOverlay button {
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
    }

    #confirmDeleteBtn {
        background-color: #e53935;
        color: white;
        box-shadow: 0 3px 8px rgba(229, 57, 53, 0.3);
    }

    #confirmDeleteBtn:hover {
        background-color: #c62828;
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(229, 57, 53, 0.4);
    }

    #cancelDeleteBtn {
        background-color: #e0e0e0;
        color: #555;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    #cancelDeleteBtn:hover {
        background-color: #c0c0c0;
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
    }

    #successPopup {
        position: fixed;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #4CAF50;
        color: white;
        padding: 15px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        font-weight: 500;
        text-align: center;
        z-index: 9999;
        opacity: 0;
        transition: top 0.5s ease-out, opacity 0.5s ease-out;
        min-width: 250px;
    }

    #successPopup.show {
        top: 20px;
        opacity: 1;
    }

    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 1000px;
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
        box-shadow: none;
    }

    th {
        background-color: #7b1fa2;
        color: #fff;
        text-transform: uppercase;
        font-weight: bold;
        border: none;
        padding: 14px 10px;
    }

    th:first-child {
        border-top-left-radius: 12px;
    }

    th:last-child {
        border-top-right-radius: 12px;
    }

    tr:last-child td:first-child {
        border-bottom-left-radius: 12px;
    }

    tr:last-child td:last-child {
        border-bottom-right-radius: 12px;
    }

    td {
        border: none;
        padding: 12px 10px;
        text-align: center;
        background: #fff;
    }

    tbody tr:nth-child(even) td {
        background: #f6f8fc;
    }

    tbody tr:hover {
        background-color: #ede7f6;
        transform: scale(1.005);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.10);
        z-index: 2;
        position: relative;
        transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
    }

    tr {
        border-bottom: 1px solid #eee;
    }

    tr:last-child {
        border-bottom: none;
    }
</style>

<div class="table-container">
    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
        <h2 class="text-2xl lg:text-3xl font-extrabold text-purple-900 tracking-wide">
            <i>Record Party Payment</i>
        </h2>
        <div class="flex items-center gap-3">
            <!-- Smart Dropdown Search -->
            <div class="dropdown-container">
                <input type="text" id="partyDropdown" placeholder="Select or search party..." class="dropdown-input"
                    autocomplete="off" readonly>
                <button type="button" class="clear-button" id="clearButton">
                    <i class="fas fa-times"></i>
                </button>
                <div class="dropdown-arrow" id="dropdownArrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="dropdown-list" id="dropdownList"></div>
            </div>
            <a href="{% url 'cash_book' %}"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center whitespace-nowrap">
                <i class="fa fa-plus mr-2"></i>
                Add Payment
            </a>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>S.No</th>
                <th>Party Name</th>
                <th>Payment Date</th>
                <th>Type of Payment</th>
                <th>Amount</th>
                <th>Mode of Payment</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in payment_records %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ payment.party }}</td>
                <td>{{ payment.payment_date|date:"Y-m-d" }}</td>
                <td>{{ payment.payment_type }}</td>
                <td>{{ payment.paid_amount }}</td>
                <td>{{ payment.payment_mode }}</td>
                <td class="actions-column">
                    <!-- <button class="edit-btn" onclick="openEditModal('{{ payment.id }}', this)">
                        <i class="fa fa-pen"></i>
                    </button> -->
                    <button class="delete-btn" onclick="confirmDelete('{{ payment.id }}')">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-gray-500 italic">No payment records found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Edit Modal -->
<div id="editPaymentModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeEditModal()">&times;</button>
        <h3>Edit Payment</h3>
        <form id="editForm">
            <div class="modal-form-group">
                <label>Party Name</label>
                <input type="text" id="editParty" />
            </div>
            <div class="modal-form-group">
                <label>Payment Date</label>
                <input type="date" id="editDate" />
            </div>
            <div class="modal-form-group">
                <label>Type of Payment</label>
                <select id="editType">
                    <option>Parcha</option>
                    <option>Part Payment</option>
                </select>
            </div>
            <div class="modal-form-group">
                <label>Amount</label>
                <input type="number" id="editAmount">
            </div>
            <div class="modal-form-group">
                <label>Mode of Payment</label>
                <select id="editMode">
                    <option>Cash</option>
                    <option>Online</option>
                    <option>Cheque</option>
                </select>
            </div>
            <button type="submit" class="modal-add-btn">Update Payment</button>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <h3>Are you sure you want to delete this record?</h3>
        <div class="modal-buttons">
            <button id="confirmDeleteBtn">Yes</button>
            <button id="cancelDeleteBtn">No</button>
        </div>
    </div>
</div>

<!-- Success Popup -->
<div id="successPopup" class="success-popup">
    Action successful!
</div>

<script>
    let currentEditId = null;
    let allParties = [];
    let filteredParties = [];
    let highlightedIndex = -1;
    let isDropdownOpen = false;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        initializeDropdown();
    });

    // Initialize dropdown functionality
    function initializeDropdown() {
        const dropdownInput = document.getElementById('partyDropdown');
        const dropdownList = document.getElementById('dropdownList');
        const dropdownArrow = document.getElementById('dropdownArrow');
        const clearButton = document.getElementById('clearButton');

        extractParties();
        createDropdownOptions(allParties);
        setupDropdownEvents();
    }

    // Extract unique parties from table and count occurrences
    function extractParties() {
        const rows = document.querySelectorAll("tbody tr");
        const partyCount = {};

        rows.forEach(row => {
            const partyCell = row.querySelector("td:nth-child(2)");
            if (partyCell && partyCell.textContent.trim() !== "No payment records found.") {
                const partyName = partyCell.textContent.trim();
                partyCount[partyName] = (partyCount[partyName] || 0) + 1;
            }
        });

        allParties = Object.keys(partyCount).sort().map(party => ({
            name: party,
            count: partyCount[party]
        }));
        filteredParties = [...allParties];
    }

    // Create dropdown options
    function createDropdownOptions(parties) {
        const dropdownList = document.getElementById('dropdownList');
        dropdownList.innerHTML = '';

        if (parties.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'no-results';
            noResults.textContent = 'No parties found';
            dropdownList.appendChild(noResults);
            return;
        }

        parties.forEach((party, index) => {
            const option = document.createElement('div');
            option.className = 'dropdown-item';
            option.dataset.value = party.name;
            option.dataset.index = index;
            option.textContent = party.name; // âœ… only the name
            dropdownList.appendChild(option);
        });
    }


    // Setup dropdown event listeners
    function setupDropdownEvents() {
        const dropdownInput = document.getElementById('partyDropdown');
        const dropdownList = document.getElementById('dropdownList');
        const dropdownArrow = document.getElementById('dropdownArrow');
        const clearButton = document.getElementById('clearButton');

        // Input click - toggle dropdown
        dropdownInput.addEventListener('click', function () {
            if (!isDropdownOpen) {
                filteredParties = [...allParties];
                createDropdownOptions(filteredParties);
                toggleDropdown(true);
            }
        });

        // Input typing
        dropdownInput.addEventListener('input', function () {
            const searchTerm = this.value;
            filterParties(searchTerm);
            clearButton.classList.toggle('show', searchTerm !== '');

            if (!isDropdownOpen) {
                toggleDropdown(true);
            }

            filterTableRows(searchTerm);
        });

        // Keyboard navigation
        dropdownInput.addEventListener('keydown', function (e) {
            if (!isDropdownOpen) return;

            const options = dropdownList.querySelectorAll('.dropdown-item:not(.no-results)');

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
                    updateHighlight();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, -1);
                    updateHighlight();
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (highlightedIndex >= 0 && options[highlightedIndex]) {
                        selectOption(options[highlightedIndex].dataset.value);
                    }
                    break;
                case 'Escape':
                    toggleDropdown(false);
                    break;
            }
        });

        // Dropdown option clicks
        dropdownList.addEventListener('click', function (e) {
            if (e.target.closest('.dropdown-item') && !e.target.closest('.no-results')) {
                const item = e.target.closest('.dropdown-item');
                selectOption(item.dataset.value);
            }
        });

        // Clear button
        clearButton.addEventListener('click', function () {
            dropdownInput.value = '';
            clearButton.classList.remove('show');
            filterTableRows('');
            toggleDropdown(false);
        });

        // Click outside to close
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.dropdown-container')) {
                toggleDropdown(false);
            }
        });
    }

    // Filter parties based on search term
    function filterParties(searchTerm) {
        if (!searchTerm) {
            filteredParties = [...allParties];
        } else {
            filteredParties = allParties.filter(party =>
                party.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
        }
        createDropdownOptions(filteredParties);
        highlightedIndex = -1;
    }

    // Toggle dropdown visibility
    function toggleDropdown(show) {
        const dropdownList = document.getElementById('dropdownList');
        const dropdownArrow = document.getElementById('dropdownArrow');
        const dropdownInput = document.getElementById('partyDropdown');

        isDropdownOpen = show;
        dropdownList.classList.toggle('show', show);
        dropdownArrow.classList.toggle('rotate', show);

        if (show) {
            dropdownInput.removeAttribute('readonly');
            dropdownInput.focus();
        } else {
            dropdownInput.setAttribute('readonly', 'true');
            highlightedIndex = -1;
            updateHighlight();
        }
    }

    // Update highlighted option
    function updateHighlight() {
        const options = document.querySelectorAll('.dropdown-item:not(.no-results)');
        options.forEach((option, index) => {
            option.classList.toggle('highlighted', index === highlightedIndex);
        });
    }

    // Select option from dropdown
    function selectOption(value) {
        const dropdownInput = document.getElementById('partyDropdown');
        const clearButton = document.getElementById('clearButton');

        dropdownInput.value = value;
        toggleDropdown(false);
        filterTableRows(value.toLowerCase());
        clearButton.classList.toggle('show', value !== '');
    }

    // Filter table rows based on search
    function filterTableRows(filter) {
        const rows = document.querySelectorAll("tbody tr");

        rows.forEach(row => {
            const partyCell = row.querySelector("td:nth-child(2)");
            if (partyCell && partyCell.textContent.trim() !== "No payment records found.") {
                const partyName = partyCell.textContent.toLowerCase();
                row.style.display = partyName.includes(filter) ? "" : "none";
            }
        });
    }

    // Function to open the edit modal and populate fields
    function openEditModal(id, btn) {
        const row = btn.closest("tr");
        document.getElementById("editParty").value = row.children[1].innerText;
        document.getElementById("editDate").value = row.children[2].innerText;
        document.getElementById("editType").value = row.children[3].innerText;
        document.getElementById("editAmount").value = row.children[4].innerText;
        document.getElementById("editMode").value = row.children[5].innerText;

        currentEditId = id;
        document.getElementById("editPaymentModal").style.display = "flex";
    }

    // Function to close the edit modal
    function closeEditModal() {
        document.getElementById("editPaymentModal").style.display = "none";
    }

    // Function to get CSRF token for AJAX requests
    function getCSRFToken() {
        const name = "csrftoken";
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            const [key, value] = cookie.trim().split("=");
            if (key === name) return decodeURIComponent(value);
        }
        return "";
    }

    // Handle form submission for editing payment
    document.getElementById("editForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const data = {
            party_name: document.getElementById("editParty").value,
            payment_date: document.getElementById("editDate").value,
            payment_type: document.getElementById("editType").value,
            amount: document.getElementById("editAmount").value,
            payment_mode: document.getElementById("editMode").value,
        };
        fetch(`/dapple/record-payments/edit/${currentEditId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showSuccessPopup("Payment updated successfully!");
                    setTimeout(() => location.reload(), 1200);
                } else {
                    alert("Update failed: " + data.error);
                }
            });
    });

    let deleteId = null;

    // Function to confirm deletion
    function confirmDelete(id) {
        deleteId = id;
        document.getElementById("deleteModalOverlay").style.display = "flex";
    }

    // Handle delete confirmation
    document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
        fetch(`/dapple/record-payments/delete/${deleteId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": getCSRFToken() }
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showSuccessPopup("Payment deleted successfully!");
                    setTimeout(() => location.reload(), 1200);
                } else {
                    alert("Delete failed: " + data.error);
                }
            });
    });

    // Handle cancel deletion
    document.getElementById("cancelDeleteBtn").addEventListener("click", function () {
        document.getElementById("deleteModalOverlay").style.display = "none";
        deleteId = null;
    });

    // Function to show success popup
    function showSuccessPopup(message) {
        const popup = document.getElementById('successPopup');
        popup.textContent = message;
        popup.classList.add('show');
        setTimeout(() => {
            popup.classList.remove('show');
        }, 3000);
    }
</script>
{% endblock %}